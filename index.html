<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STO373 Goods Arrival Plan Search</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet"/>

  <style>
    :root { --ikea-blue:#0058a3; --ikea-yellow:#ffdb00; --bg-color:#f5f7f8; --text-dark:#111; --sidebar-width:250px; }
    body { font-family:'Noto Sans KR','Roboto',sans-serif; background-color:var(--bg-color); margin:0; padding:0; color:var(--text-dark); display:flex; flex-direction:column; min-height:100vh; }

    /* Header */
    header { background-color:var(--ikea-blue); color:#fff; padding:0 40px; height:100px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:2000; width:100%; box-sizing:border-box; flex-shrink:0; }
    .header-left{ display:flex; flex-direction:column; justify-content:center; align-items:flex-start; }
    .main-title{ color:#fff; text-decoration:none; font-size:1.4rem; font-weight:700; display:flex; align-items:center; gap:10px; transition:opacity .2s; }
    .main-title:hover{ opacity:.8; text-decoration:underline; }
    .link-group{ display:flex; gap:20px; margin-top:5px; margin-left:38px; flex-wrap:wrap; }
    .header-sub-link{ color:var(--ikea-yellow); text-decoration:none; font-weight:500; font-size:.95rem; font-family:'Roboto',sans-serif; display:flex; align-items:center; gap:5px; transition:opacity .2s; }
    .header-sub-link:hover{ opacity:.8; text-decoration:underline; }
    .header-right{ text-align:right; font-size:.75rem; line-height:1.3; opacity:.9; }

    /* Container */
    .app-container{ display:flex; flex:1; width:100%; overflow:hidden; }
    .sidebar{ width:var(--sidebar-width); background:#95a5a6; color:#fff; display:flex; flex-direction:column; flex-shrink:0; padding-top:20px; }
    .nav-item{ padding:15px 20px; cursor:pointer; transition:all .2s; font-size:1.1rem; border-bottom:1px solid rgba(255,255,255,.1); }
    .nav-item:hover{ background:rgba(255,255,255,.1); }
    .nav-item.active{ background:#fff; color:var(--ikea-blue); font-weight:bold; border-left:6px solid var(--ikea-yellow); }
    .nav-sub{ font-size:.8rem; opacity:.7; display:block; font-weight:300; margin-top:2px; }
    .content-area{ flex:1; padding:40px; overflow-y:auto; background:var(--bg-color); }
    .tab-content{ display:none; width:100%; flex-direction:column; align-items:center; }
    .tab-content.active{ display:flex; }

    /* Badges */
    .status-badge{ display:inline-block; padding:5px 12px; border-radius:20px; font-size:.8rem; font-weight:bold; background:#fff3cd; color:#856404; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .status-badge.connected{ background:#d4edda; color:#155724; }
    .status-badge.error{ background:#f8d7da; color:#721c24; }

    /* Article Search */
    .search-card{ background:#fff; padding:40px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,.05); width:100%; max-width:800px; text-align:left; position:relative; }
    .search-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .search-title{ font-size:1.2rem; font-weight:600; color:var(--ikea-blue); display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .input-wrapper{ display:flex; gap:10px; height:50px; }
    input[type="text"]{ flex-grow:1; padding:0 15px; border:1px solid #ccc; border-radius:4px; font-size:1rem; }
    .btn-search{ background:var(--ikea-blue); color:#fff; border:none; padding:0 25px; border-radius:4px; font-weight:700; cursor:pointer; font-size:1rem; white-space:nowrap; line-height:1.2; }
    .btn-scan-trigger{ display:none; background:#333; color:#fff; border:none; padding:0 15px; border-radius:4px; cursor:pointer; font-size:1.2rem; align-items:center; justify-content:center; }
    .helper-text{ margin-top:15px; font-size:.85rem; color:#777; line-height:1.6; }
    #loading{ display:none; margin-top:15px; color:var(--ikea-blue); text-align:center; }

    .result-section{ width:100%; max-width:1200px; margin-top:30px; display:none; }
    .status-msg{ padding:15px; border-radius:4px; color:#fff; font-weight:bold; text-align:center; margin-bottom:20px; max-width:700px; margin-left:auto; margin-right:auto; line-height:1.4; }
    .status-success{ background:#008844; } .status-fail{ background:#cc0000; }

    .dashboard{ display:flex; gap:20px; margin-bottom:30px; max-width:1000px; margin-inline:auto; }
    .dash-card{ flex:1; background:#fff; padding:20px; border-radius:8px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,.05); border-top:4px solid var(--ikea-blue); }
    .dash-card h3{ font-size:2rem; margin:10px 0 5px; color:var(--text-dark); white-space:nowrap; }
    .dash-card p{ font-size:.8rem; color:#888; text-transform:uppercase; margin:0; }

    .table-wrap{ background:#fff; border-radius:8px; overflow-x:auto; box-shadow:0 2px 5px rgba(0,0,0,.05); }
    table{ width:100%; border-collapse:collapse; }
    .pc-table-view th{ background:#f9f9f9; padding:15px; font-size:.8rem; color:#555; text-align:left; }
    .pc-table-view td{ padding:15px; border-bottom:1px solid #eee; font-size:.9rem; }

    /* Mobile cards */
    .mobile-result-view{ display:none; width:100%; max-width:600px; margin:0 auto; }
    .product-summary-card{ background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.1); margin-bottom:20px; border-left:5px solid var(--ikea-yellow); }
    .summary-row{ display:flex; justify-content:space-between; margin-bottom:8px; font-size:.9rem; border-bottom:1px dashed #eee; padding-bottom:8px; }
    .schedule-list{ display:flex; flex-direction:column; gap:10px; }
    .schedule-item{ background:#fff; padding:15px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 1px 3px rgba(0,0,0,.1); border-left:4px solid #ccc; }
    .schedule-item.fixed-date{ border-left-color:var(--ikea-blue); }
    .schedule-date{ font-size:1.1rem; font-weight:700; color:#333; }
    .schedule-qty{ font-size:1.2rem; font-weight:800; color:var(--ikea-blue); text-align:right; }
    .schedule-container{ font-size:.75rem; color:#777; margin-top:2px; text-align:right; }

    .date-confirmed{ color:#27ae60; font-weight:bold; }
    .date-estimated{ color:#d35400; font-weight:bold; font-size:.9em; background:#ffeaa7; padding:2px 6px; border-radius:4px; }
    .not-fixed-col{ background:#fff0f0; color:#c0392b; font-weight:bold; min-width:80px; }
    .qty-cell{ font-weight:bold; color:var(--ikea-blue); }
    .date-col{ background:#fff; min-width:80px; font-weight:bold; color:var(--ikea-blue); }
    .filter-input{ width:90%; padding:4px; margin-top:5px; border:1px solid #ccc; border-radius:3px; font-size:.8rem; text-align:center; }
    .filter-input:focus{ border-color:var(--ikea-blue); outline:none; background:#f0f8ff; }

    .pivot-container{ width:100%; overflow-x:auto; background:#fff; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.05); padding:20px; box-sizing:border-box; }
    .pivot-table{ width:100%; border-collapse:collapse; min-width:1200px; }
    .pivot-table thead th{ background:#f1f2f6; color:#333; padding:10px; border:1px solid #ddd; font-size:.85rem; text-align:center; position:sticky; top:0; z-index:1; }
    .pivot-table tbody td{ padding:8px 10px; border:1px solid #eee; font-size:.85rem; text-align:center; }
    .pivot-table tbody tr:hover{ background:#f9f9f9; }

    .limit-warning{ text-align:center; padding:10px; color:#7f8c8d; font-size:.85rem; background:#f9f9f9; border-top:1px solid #eee; }
    .en-sub{ font-size:.75em; color:#777; font-weight:300; margin-left:6px; font-family:'Roboto',sans-serif; }
    .en-block{ display:block; font-size:.85em; color:#888; margin-top:3px; font-weight:300; font-family:'Roboto',sans-serif; }
    .en-btn{ font-size:.75em; display:block; font-weight:300; opacity:.9; margin-top:-2px; }
    .en-white{ color:rgba(255,255,255,.85); }

    .pc-only-text{ display:block; } .mobile-only-text{ display:none; }
    footer{ background:#eef0f3; text-align:center; padding:15px 0; color:#888; font-size:.75rem; border-top:1px solid #e0e0e0; width:100%; flex-shrink:0; }

    /* Scanner modal */
    #scanner-modal{ position:fixed; inset:0; background:rgba(0,0,0,.95); z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; }
    #reader{ width:100%; max-width:500px; background:#000; border-radius:8px; overflow:hidden; }
    .scan-controls{ margin-top:20px; display:flex; gap:15px; }
    .btn-modal{ padding:10px 20px; border-radius:30px; border:none; font-weight:bold; cursor:pointer; font-size:1rem; }
    .btn-close{ background:#fff; color:#000; }

    @media (max-width:768px){
      .app-container{ flex-direction:column; display:block; }
      .sidebar{ width:100%; height:auto; flex-direction:row; padding-top:0; }
      .nav-item{ flex:1; text-align:center; padding:12px; border-right:1px solid #ddd; }
      .nav-item.active{ border-left:none; border-bottom:4px solid var(--ikea-yellow); }
      .content-area{ padding:20px 10px; }
      header{ height:auto; padding:20px; flex-direction:column; gap:10px; text-align:center; }
      .header-left{ align-items:center; }
      .link-group{ margin-left:0; justify-content:center; }
      .search-card{ padding:20px; }
      .btn-scan-trigger{ display:flex; }
      .dashboard{ gap:10px; }
      .dash-card{ padding:15px 5px; }
      .dash-card h3{ font-size:1.3rem; }
      .pc-table-view{ display:none !important; }
      .mobile-result-view{ display:block; }
    }
  </style>
</head>
<body>
  <div id="scanner-modal" role="dialog" aria-modal="true" aria-label="바코드 스캐너">
    <div style="color:white; margin-bottom:10px; text-align:center;">
      <i class="fas fa-barcode"></i> 바코드에 카메라를 대주세요
      <div class="en-block en-white">Point camera at barcode</div>
    </div>
    <div id="reader" aria-label="barcode camera preview"></div>
    <div class="scan-controls">
      <button class="btn-modal btn-close" onclick="stopScanner()" aria-label="스캐너 닫기">닫기</button>
    </div>
  </div>

  <header>
    <div class="header-left">
      <a href="." class="main-title" aria-label="메인으로">
        <i class="fas fa-truck-fast" style="color:var(--ikea-yellow);"></i>
        STO373 Goods Arrival Plan Search
      </a>
      <div class="link-group" aria-label="바로가기">
        <a href="https://coworker.ingka.com/kr/ko/v1/" target="_blank" class="header-sub-link" rel="noopener">SäljaPro <i class="fas fa-external-link-alt" style="font-size:.8em;"></i></a>
        <a href="https://www.ikea.com/kr/ko/" target="_blank" class="header-sub-link" rel="noopener">IKEA Home <i class="fas fa-home" style="font-size:.8em;"></i></a>
        <a href="https://mhs-373.ikea.com/gateway/" target="_blank" class="header-sub-link" rel="noopener">MHS <i class="fas fa-warehouse" style="font-size:.8em;"></i></a>
        <a href="https://piafacts.ikea.net/kr/en" target="_blank" class="header-sub-link" rel="noopener">PIA Facts <i class="fas fa-info-circle" style="font-size:.8em;"></i></a>
      </div>
    </div>
    <div class="header-right">
      Ver 4.0 Date Fix<br/>
      Bilingual Support
      <div id="data-update-date" style="font-size:.9em; color:var(--ikea-yellow); margin-top:3px; font-weight:500;">data update : -</div>
    </div>
  </header>

  <div class="app-container">
    <nav class="sidebar" aria-label="탭 메뉴">
      <div class="nav-item active" onclick="switchTab('search')" id="nav-search" role="button" tabindex="0" aria-controls="tab-search">Article Search <span class="nav-sub">제품 검색</span></div>
      <div class="nav-item" onclick="switchTab('arrival')" id="nav-arrival" role="button" tabindex="0" aria-controls="tab-arrival">Goods Arrival <span class="nav-sub">상품 도착 현황</span></div>
    </nav>

    <div class="content-area">
      <div id="tab-search" class="tab-content active">
        <div class="search-card">
          <div class="search-header">
            <div class="search-title"><i class="fas fa-search"></i> 검색 (제품 번호 8자리) <span class="en-sub">Search (Item No 8 digits)</span></div>
            <div class="status-badge" id="statusBadge1"><i class="fas fa-spinner fa-spin"></i> 연결 중...</div>
          </div>
          <div class="input-wrapper">
            <input type="text" id="itemInput" placeholder="예: 80518273 (e.g.)" maxlength="20" aria-label="제품번호 또는 컨테이너 검색 입력"/>
            <button class="btn-scan-trigger" onclick="startScanner()" title="바코드 스캔" aria-label="바코드 스캔"><i class="fas fa-camera"></i></button>
            <button class="btn-search" onclick="performSearch()" aria-label="검색 실행">검색 <span class="en-btn">Search</span></button>
          </div>
          <div class="helper-text">
            <i class="fas fa-lightbulb" style="color:var(--ikea-yellow);"></i>
            <strong>Tip:</strong>
            <div class="pc-only-text">8자리 숫자를 입력 후 검색을 눌러주세요.</div>
            <div class="mobile-only-text">모바일에서는 카메라 아이콘을 눌러 바코드를 자동으로 입력할 수 있습니다.</div>
          </div>
          <div id="loading"><i class="fas fa-spinner fa-spin fa-2x"></i><br/>데이터 검색 중...</div>
        </div>

        <div id="resultSection" class="result-section" aria-live="polite">
          <div id="statusBar" class="status-msg"></div>

          <div class="dashboard">
            <div class="dash-card"><h3 id="totalResults">-</h3><p>Total Results</p></div>
            <div class="dash-card"><h3 id="futureDeliveryQty">0</h3><p>Future Qty</p></div>
            <div class="dash-card"><h3 id="nextDeliveryDate">-</h3><p>Next Delivery</p></div>
          </div>

          <div class="pc-table-view">
            <div class="table-wrap">
              <table aria-label="검색 결과">
                <thead><tr><th>HFB</th><th>ITEM NO</th><th>ITEM NAME</th><th>SSD</th><th>EDS</th><th>PLANNED DATE</th><th>QTY</th><th>CONTAINER</th></tr></thead>
                <tbody id="pcResultBody"></tbody>
              </table>
            </div>
          </div>

          <div class="mobile-result-view">
            <div id="mobileProductSummary" class="product-summary-card"></div>
            <div id="mobileScheduleList" class="schedule-list"></div>
          </div>
        </div>
      </div>

      <div id="tab-arrival" class="tab-content">
        <div class="pivot-container">
          <div class="pivot-header-area" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="color:var(--ikea-blue); margin:0;">
              <i class="fas fa-calendar-alt"></i> Goods Arrival Overview
              <span class="en-sub" style="font-size:.6em; display:block; margin-left:0; margin-top:5px;">오늘부터 미래의 도착 예정 물량을 보여줍니다.</span>
            </h2>
            <div class="status-badge" id="statusBadge2"><i class="fas fa-spinner fa-spin"></i> 연결 중...</div>
          </div>

          <div style="overflow-x:auto;">
            <table class="pivot-table" id="pivotTable" aria-label="상품 도착 피벗 테이블">
              <thead id="pivotHead"></thead>
              <tbody id="pivotBody"></tbody>
            </table>
            <div id="pivotLoading" style="text-align:center; padding:20px; color:#777; display:none;">
              <i class="fas fa-spinner fa-spin"></i> 데이터를 불러오는 중입니다...
            </div>
            <div id="limitWarning" class="limit-warning" style="display:none;">
              <i class="fas fa-info-circle"></i>
              성능 최적화를 위해 상위 3000개 결과만 표시됩니다. 더 찾으려면 필터를 사용하세요.
              <br/><span class="en-sub">Showing top 3000 results for performance. Please use filters to refine.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <strong>STO373 Goods arrival Tool</strong> — Powered by automated STO373 FI
  </footer>

  <script>
    // =====================
    // State
    // =====================
    const EXCEL_FILE_URL = './STO373 Goods arrival plan.xlsx';
    let rawHeader = [];
    let rawRows = [];          // 2D array (excluding header)
    let data = [];             // normalized objects after header mapping
    let pivotAllRows = [];     // processed pivot rows
    let pivotDates = [];       // header date columns
    let html5QrcodeScanner = null;

    // =====================
    // Utilities
    // =====================
    const debounce = (fn, t=300) => { let tm; return (...a)=>{clearTimeout(tm); tm=setTimeout(()=>fn(...a), t);} };
    const fmtInt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
    const safeNum = v => Number.isFinite(+v) ? +v : 0;
    const pad2 = n => String(n).padStart(2,'0');
    const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    function getWeekNumber(d){
      const target = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNr = (target.getUTCDay() + 6) % 7; // Monday=0
      target.setUTCDate(target.getUTCDate() - dayNr + 3); // Thursday
      const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
      const diff = target - firstThursday;
      return 1 + Math.round(diff / (7*24*3600*1000));
    }
    function escapeHtml(str=''){
      return String(str).replace(/[&<>"'`=\/]/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
      }[s]));
    }

    // Excel mixed date to Date|null
    // [FIX] Reverting to the 12-hour buffer logic for serial numbers
    function excelToDate(v){
      if(!v && v!==0) return null;
      if (typeof v === 'number'){
        // Excel serial (assuming 1900 system)
        if(v > 10000 && v < 60000){ 
          // [FIX] Add 12 hours (43200000ms) to prevent timezone shifts (One day off issue)
          const d = new Date(Math.round((v - 25569) * 86400 * 1000) + 43200000);
          return isNaN(d) ? null : d;
        }
        // YYYYMMDD as number
        if (v >= 19000101 && v <= 29991231){
          const s = String(v);
          const d = new Date(`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}T00:00:00`);
          return isNaN(d) ? null : d;
        }
      }
      if (typeof v === 'string'){
        const s = v.trim();
        if (/^\d{8}$/.test(s)){ // YYYYMMDD
          const d = new Date(`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}T00:00:00`);
          return isNaN(d) ? null : d;
        }
        const d = new Date(s);
        return isNaN(d) ? null : d;
      }
      if (v instanceof Date) return v;
      return null;
    }

    // =====================
    // Header mapping (case/space insensitive + aliases)
    // =====================
    const ALIASES = {
      ItemNo: ['ItemNo','ITEM NO','ARTNO','ITEMNO'],
      ItemName: ['ItemName','ITEM NAME','ARTNAME','ARTNAME_UNICODE','ITEMNAME'],
      PA: ['PA'],
      HFB: ['HFB'],
      SSD: ['SSD'],
      EDS: ['EDS'],
      PlannedReceivingDate: ['Planned Receiving Date','PLANNED RECEIVING DATE','PLANNED DATE','PlannedDate'],
      Port: ['Port','PORT'],
      ArrivalDate: ['Arrival Date','Arrival','ARRIVAL'],
      LatestQty: ['LatestQty','LATESTQTY','QTY','Quantity'],
      Container: ['Container','CONTAINER','ContainerNo','Container No'],
      Activity: ['Activity & offer','Activity','Activity & Offer','ACTIVITY & OFFER']
    };
    function normKey(s){ return String(s||'').toLowerCase().replace(/[\s_\\/-]+/g,'').replace(/[^\w]/g,''); }
    function findColIndex(header, candidates){
      if(!header || !header.length) return -1;
      const normHeader = header.map(h => normKey(h));
      for (const c of candidates){
        const n = normKey(c);
        const idx = normHeader.indexOf(n);
        if (idx !== -1) return idx;
      }
      // fallback: includes match
      for (let i=0;i<header.length;i++){
        for (const c of candidates){
          if (normHeader[i].includes(normKey(c))) return i;
        }
      }
      return -1;
    }

    function buildColumnMap(header){
      const map = {};
      for (const k of Object.keys(ALIASES)){
        map[k] = findColIndex(header, ALIASES[k]);
      }
      return map;
    }

    // =====================
    // UI Status
    // =====================
    function updateStatus(status){
      const b1 = document.getElementById('statusBadge1');
      const b2 = document.getElementById('statusBadge2');
      if (status === 'connected'){
        const html = `<i class="fas fa-check-circle"></i> 데이터 연결됨`;
        b1.innerHTML = html; b1.className = 'status-badge connected';
        b2.innerHTML = html; b2.className = 'status-badge connected';
      } else {
        const html = `<i class="fas fa-exclamation-triangle"></i> 연결 실패`;
        b1.innerHTML = html; b1.className = 'status-badge error';
        b2.innerHTML = html; b2.className = 'status-badge error';
      }
    }

    function switchTab(tab){
      document.getElementById('tab-search').classList.remove('active');
      document.getElementById('tab-arrival').classList.remove('active');
      document.getElementById('nav-search').classList.remove('active');
      document.getElementById('nav-arrival').classList.remove('active');
      document.getElementById('tab-'+tab).classList.add('active');
      document.getElementById('nav-'+tab).classList.add('active');

      if (tab === 'arrival'){
        if (pivotAllRows.length) updatePivotDisplay(pivotAllRows);
        else if (data.length) renderPivot(data);
        else {
          document.getElementById('pivotBody').innerHTML='';
          document.getElementById('pivotLoading').style.display='block';
        }
      }
    }

    // =====================
    // Load & Parse Excel
    // =====================
    window.onload = async function(){
      try{
        const uniqueUrl = EXCEL_FILE_URL + '?t=' + new Date().getTime();
        const resp = await fetch(uniqueUrl);
        const lastModified = resp.headers.get('Last-Modified');
        if (lastModified){
          const d = new Date(lastModified);
          document.getElementById('data-update-date').innerText = `data update : ${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        }
        if (!resp.ok) throw new Error('Excel file not found');
        const buf = await resp.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array' });

        // Prefer "Orderinformation"
        let sheetName = wb.SheetNames.find(n => String(n).toLowerCase().includes('orderinformation')) || wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];

        // 2D array, header: first row
        const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'', raw:true });
        rawHeader = (rows[0] || []).map(x=>String(x).trim());
        rawRows = rows.slice(1);

        // Build column map (tolerant to header variance)
        const COL = buildColumnMap(rawHeader);

        // Normalize rows to objects
        data = rawRows.map(r => ({
          itemNo: String(r[COL.ItemNo] ?? '').trim(),
          itemName: r[COL.ItemName] ?? '',
          pa: r[COL.PA] ?? '',
          hfb: r[COL.HFB] ?? '',
          ssd: r[COL.SSD] ?? '',
          eds: r[COL.EDS] ?? '',
          plannedDate: r[COL.PlannedReceivingDate],
          portDate: r[COL.Port],
          arrivalDate: r[COL.ArrivalDate],
          qty: safeNum(r[COL.LatestQty]),
          container: String(r[COL.Container] ?? '').trim(),
          activity: r[COL.Activity] ?? ''
        }));

        updateStatus('connected');

        // Pre-warm pivot in background
        setTimeout(()=> renderPivot(data, false), 300);

      }catch(e){
        console.error(e);
        updateStatus('error');
        alert("데이터 파일을 불러오지 못했습니다.\n- 파일 경로/이름 확인\n- 브라우저 캐시 삭제 후 새로고침\n- 로컬/서버 CORS 설정 확인");
      }
    };

    // =====================
    // Search Tab
    // =====================
    document.getElementById('itemInput').addEventListener('keypress', e => { if (e.key==='Enter') performSearch(); });

    function parseExcelDate(value){
      const d = excelToDate(value);
      return d ? ymd(d) : '-';
    }

    function determinePlanned(row){
      // 1) 확정 Planned Receiving Date
      const pd = excelToDate(row.plannedDate);
      const today = new Date(); today.setHours(0,0,0,0);

      if (pd){
        const dd = new Date(pd); dd.setHours(0,0,0,0);
        if (dd >= today){
          return { type:'confirmed', dateObj: dd, label: ymd(dd) };
        }
      }
      // 2) Port + 7일 → 주차 예상
      const port = excelToDate(row.portDate);
      if (port){
        const est = addDays(port, 7);
        const wk = getWeekNumber(est);
        return { type:'estimated', dateObj: null, label: `<span class="date-estimated">WK${wk} 예상</span>` };
      }
      // 3) 미정
      return { type:'tbd', dateObj: null, label: `<span class="date-estimated">미정</span>` };
    }

    function performSearch(){
      const raw = document.getElementById('itemInput').value.trim();
      if (!raw){ alert('제품번호를 입력해주세요.'); return; }
      const target = raw.replace(/[^0-9A-Za-z]/g,'').toLowerCase();

      document.getElementById('loading').style.display='block';
      document.getElementById('resultSection').style.display='none';

      setTimeout(()=> {
        const results = searchData(target);
        renderSearchResults(results);
        document.getElementById('loading').style.display='none';
      }, 150);
    }

    function searchData(target){
      const grouped = new Map();
      const today = new Date(); today.setHours(0,0,0,0);

      data.forEach(row => {
        const itemNo = String(row.itemNo||'').replace(/\s+/g,'').toLowerCase();
        const cont = String(row.container||'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase();
        const isMatch = (itemNo && (itemNo.includes(target) || target.includes(itemNo))) ||
                        (cont && cont.includes(target));
        if (!isMatch) return;

        // 날짜 판단
        const plan = determinePlanned(row);
        // 과거 확정일 제외
        if (plan.type==='confirmed'){
          const d = excelToDate(row.plannedDate);
          if (d){
            const dd = new Date(d); dd.setHours(0,0,0,0);
            if (dd < today) return;
          }
        }
        const container = row.container || '배송준비중';
        const key = `${container}__${plan.label}`;

        const qty = safeNum(row.qty);
        if (grouped.has(key)){
          grouped.get(key).quantity += qty;
        } else {
          grouped.set(key, {
            hfb: row.hfb,
            itemNo: String(row.itemNo||'').trim(),
            itemName: row.itemName,
            ssdRaw: row.ssd,
            edsRaw: row.eds,
            plannedDateStr: plan.label,
            plannedDateObj: plan.type==='confirmed' ? excelToDate(row.plannedDate) : null,
            quantity: qty,
            container
          });
        }
      });
      return Array.from(grouped.values());
    }

    function renderSearchResults(results){
      const resultSection = document.getElementById('resultSection');
      const statusBar = document.getElementById('statusBar');
      const pcTbody = document.getElementById('pcResultBody');
      const mobileScheduleList = document.getElementById('mobileScheduleList');
      const mobileProductSummary = document.getElementById('mobileProductSummary');

      resultSection.style.display='block';
      pcTbody.innerHTML=''; mobileScheduleList.innerHTML=''; mobileProductSummary.innerHTML='';

      if (!results.length){
        statusBar.innerHTML = `검색 결과가 존재하지 않습니다.<br/><span style="font-size:.8em">(과거 날짜는 표시되지 않습니다)</span>`;
        statusBar.className = 'status-msg status-fail';
        document.querySelector('.dashboard').style.display='none';
        return;
      }
      statusBar.innerHTML = `${results.length}개의 배송 계획을 찾았습니다! <div class="en-white" style="font-size:.85em; opacity:.9; font-weight:300;">Found ${results.length} arrival plans!</div>`;
      statusBar.className = 'status-msg status-success';
      document.querySelector('.dashboard').style.display='flex';

      // Dashboard
      document.getElementById('totalResults').innerText = results.length;
      results.sort((a,b) => {
        const A = a.plannedDateObj || new Date(9999,0,1);
        const B = b.plannedDateObj || new Date(9999,0,1);
        return A - B;
      });
      const future = results.filter(r => r.plannedDateObj);
      if (future.length){
        const nextDate = future[0].plannedDateStr;
        const totalNext = future.filter(r => r.plannedDateStr === nextDate).reduce((s,i)=>s+i.quantity,0);
        document.getElementById('futureDeliveryQty').innerText = fmtInt.format(totalNext);
        document.getElementById('nextDeliveryDate').innerText = nextDate.replace(/<[^>]*>/g,'');
      } else {
        document.getElementById('futureDeliveryQty').innerText = '0';
        document.getElementById('nextDeliveryDate').innerText = '-';
      }

      // PC table (1회 주입)
      const rowsHtml = results.map(r => {
        const dateHtml = /^\d{4}-\d{2}-\d{2}$/.test(r.plannedDateStr)
          ? `<span class="date-confirmed">${r.plannedDateStr}</span>` : r.plannedDateStr;
        return `
          <tr>
            <td>${escapeHtml(r.hfb)}</td>
            <td><strong>${escapeHtml(r.itemNo)}</strong></td>
            <td style="text-align:left;">${escapeHtml(r.itemName)}</td>
            <td>${escapeHtml(parseExcelDate(r.ssdRaw))}</td>
            <td>${escapeHtml(parseExcelDate(r.edsRaw))}</td>
            <td>${dateHtml}</td>
            <td class="qty-cell">${fmtInt.format(r.quantity)}</td>
            <td>${escapeHtml(r.container)}</td>
          </tr>`;
      }).join('');
      pcTbody.innerHTML = rowsHtml;

      // Mobile summary (첫 건 요약 + 세부 스케줄)
      const c = results[0];
      mobileProductSummary.innerHTML = `
        <div class="summary-row"><span>Item No</span><span style="font-size:1.2rem; color:var(--ikea-blue);">${escapeHtml(c.itemNo)}</span></div>
        <div class="summary-row"><span>Name</span><span>${escapeHtml(c.itemName)}</span></div>
        <div class="summary-row"><span>HFB</span><span>${escapeHtml(c.hfb)}</span></div>
      `;
      mobileScheduleList.innerHTML = results.map(r => `
        <div class="schedule-item ${/^\d{4}-\d{2}-\d{2}$/.test(r.plannedDateStr) ? 'fixed-date' : ''}">
          <div class="schedule-date">${r.plannedDateStr}</div>
          <div class="schedule-details" style="text-align:right;">
            <div class="schedule-qty">${fmtInt.format(r.quantity)} ea</div>
            <div class="schedule-container"><i class="fas fa-box"></i> ${escapeHtml(r.container)}</div>
          </div>
        </div>
      `).join('');
    }

    // =====================
    // Pivot Tab
    // =====================
    function renderPivot(list, shouldRender=true){
      const today = new Date(); today.setHours(0,0,0,0);
      const pivotMap = {};
      const unique = new Set();

      list.forEach(row => {
        if (!row.itemNo) return;
        const pd = excelToDate(row.plannedDate);
        const qty = safeNum(row.qty);

        // init row
        if (!pivotMap[row.itemNo]){
          pivotMap[row.itemNo] = {
            hfb: row.hfb||'',
            pa: row.pa||'',
            itemNo: row.itemNo,
            itemName: row.itemName||'',
            activity: row.activity||'',
            dates: {},
            notFixedQty: 0
          };
        }
        if (pd){
          const dd = new Date(pd); dd.setHours(0,0,0,0);
          if (dd >= today){
            const key = ymd(dd);
            pivotMap[row.itemNo].dates[key] = (pivotMap[row.itemNo].dates[key]||0) + qty;
            unique.add(key);
          }
        } else {
          pivotMap[row.itemNo].notFixedQty += qty;
        }
      });

      pivotDates = Array.from(unique).sort();

      // Header with data-field binding
      let head = `
        <tr>
          <th>HFB<br/><input data-field="hfb" class="filter-input" placeholder="Filter" aria-label="HFB 필터"/></th>
          <th>PA<br/><input data-field="pa" class="filter-input" placeholder="Filter" aria-label="PA 필터"/></th>
          <th>Item No<br/><input data-field="itemNo" class="filter-input" placeholder="Filter" aria-label="ItemNo 필터"/></th>
          <th class="col-hide-mobile">Item Name<br/><input data-field="itemName" class="filter-input" placeholder="Filter" aria-label="ItemName 필터"/></th>
          <th class="col-hide-mobile">Activity<br/><input data-field="activity" class="filter-input" placeholder="Filter" aria-label="Activity 필터"/></th>
          <th class="not-fixed-col">미정<br/>(Not Fixed)</th>`;
      pivotDates.forEach(d => head += `<th class="date-col">${d}</th>`);
      head += `</tr>`;
      document.getElementById('pivotHead').innerHTML = head;

      pivotAllRows = Object.values(pivotMap).sort((a,b)=>{
        if (String(a.hfb) !== String(b.hfb)) return String(a.hfb).localeCompare(String(b.hfb));
        return String(a.pa).localeCompare(String(b.pa));
      });

      document.getElementById('pivotLoading').style.display='none';

      // Bind filters once
      document.querySelectorAll('#pivotTable .filter-input').forEach(inp=>{
        inp.addEventListener('input', debounce(filterPivot, 300));
      });

      if (shouldRender) updatePivotDisplay(pivotAllRows);
    }

    function updatePivotDisplay(rows){
      const tbody = document.getElementById('pivotBody');
      const limitWarning = document.getElementById('limitWarning');
      const LIMIT = 3000;

      let html = '';
      const count = Math.min(rows.length, LIMIT);
      for (let i=0;i<count;i++){
        const r = rows[i];
        const notFixed = r.notFixedQty > 0 ? fmtInt.format(r.notFixedQty) : '';
        html += `<tr>
          <td>${escapeHtml(r.hfb)}</td>
          <td>${escapeHtml(r.pa)}</td>
          <td><b>${escapeHtml(r.itemNo)}</b></td>
          <td class="col-hide-mobile" style="text-align:left;">${escapeHtml(r.itemName)}</td>
          <td class="col-hide-mobile">${escapeHtml(r.activity)}</td>
          <td class="not-fixed-col">${notFixed}</td>`;
        pivotDates.forEach(d=>{
          const q = r.dates[d] || '';
          html += `<td class="qty-cell">${q ? fmtInt.format(q) : ''}</td>`;
        });
        html += `</tr>`;
      }
      tbody.innerHTML = html;

      limitWarning.style.display = rows.length > LIMIT ? 'block' : 'none';
    }

    function filterPivot(){
      // Collect active filters
      const filters = {};
      document.querySelectorAll('#pivotTable .filter-input').forEach(i=>{
        filters[i.dataset.field] = i.value.trim().toUpperCase();
      });
      const filtered = pivotAllRows.filter(r=>{
        if (filters.hfb && String(r.hfb).toUpperCase().indexOf(filters.hfb)===-1) return false;
        if (filters.pa && String(r.pa).toUpperCase().indexOf(filters.pa)===-1) return false;
        if (filters.itemNo && String(r.itemNo).toUpperCase().indexOf(filters.itemNo)===-1) return false;
        if (filters.itemName && String(r.itemName).toUpperCase().indexOf(filters.itemName)===-1) return false;
        if (filters.activity && String(r.activity).toUpperCase().indexOf(filters.activity)===-1) return false;
        return true;
      });
      updatePivotDisplay(filtered);
    }

    // =====================
    // QR/Barcode
    // =====================
    function startScanner(){
      document.getElementById('scanner-modal').style.display='flex';
      if (!html5QrcodeScanner){
        html5QrcodeScanner = new Html5Qrcode('reader');
      }
      html5QrcodeScanner.start(
        { facingMode:'environment' },
        { fps:15, qrbox:{ width:300, height:150 }, aspectRatio:1.0 },
        onScanSuccess
      ).catch(e => alert('Camera Error'));
    }
    function onScanSuccess(text){
      document.getElementById('itemInput').value = text.replace(/[^0-9]/g,'');
      stopScanner().then(()=>performSearch());
    }
    async function stopScanner(){
      try{
        if (html5QrcodeScanner){
          await html5QrcodeScanner.stop();
        }
      }catch(e){
        console.warn('Scanner stop failed:', e);
      }finally{
        document.getElementById('scanner-modal').style.display='none';
      }
    }
  </script>
</body>
</html>
