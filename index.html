<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="STO373 Arrival">
  <link rel="apple-touch-icon" href="./Search.jpg">
  <meta name="theme-color" content="#0058a3">

  <title>STO373 Goods Arrival Plan Search</title>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3MWM51MSF8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3MWM51MSF8');
  </script>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet"/>

  <style>
    :root { --ikea-blue:#0058a3; --ikea-yellow:#ffdb00; --bg-color:#f5f7f8; --text-dark:#111; --sidebar-width:250px; }
    body { font-family:'Noto Sans KR','Roboto',sans-serif; background-color:var(--bg-color); margin:0; padding:0; color:var(--text-dark); display:flex; flex-direction:column; min-height:100vh; }

    /* Header */
    header { background-color:var(--ikea-blue); color:#fff; padding:0 40px; height:100px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:2000; width:100%; box-sizing:border-box; flex-shrink:0; }
    .header-left{ display:flex; flex-direction:column; justify-content:center; align-items:flex-start; }
    .main-title{ color:#fff; text-decoration:none; font-size:1.4rem; font-weight:700; display:flex; align-items:center; gap:10px; transition:opacity .2s; }
    .link-group{ display:flex; gap:20px; margin-top:5px; margin-left:38px; }
    .header-sub-link{ color:var(--ikea-yellow); text-decoration:none; font-weight:500; font-size:.95rem; font-family:'Roboto',sans-serif; display:flex; align-items:center; gap:6px; }
    .header-right{ display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 2px; text-align:right; font-size:.75rem; line-height:1.2; opacity:.9; }

    #stale-alert { display: none; width: 100%; background-color: #e74c3c; color: white; text-align: center; padding: 10px; font-weight: bold; font-size: 0.9rem; z-index: 1999; }

    /* Layout */
    .app-container{ display:flex; flex:1; width:100%; overflow:hidden; }
    .sidebar{ width:var(--sidebar-width); background:#95a5a6; color:#fff; display:flex; flex-direction:column; flex-shrink:0; padding-top:20px; }
    .nav-item{ padding:15px 20px; cursor:pointer; transition:all .2s; font-size:1.1rem; border-bottom:1px solid rgba(255,255,255,.1); }
    .nav-item:hover{ background:rgba(255,255,255,.1); }
    .nav-item.active{ background:#fff; color:var(--ikea-blue); font-weight:bold; border-left:6px solid var(--ikea-yellow); }
    .nav-sub{ font-size:.8rem; opacity:.7; display:block; font-weight:300; margin-top:2px; }
    .content-area{ flex:1; padding:40px; overflow-y:auto; background:var(--bg-color); }
    .tab-content{ display:none; width:100%; flex-direction:column; align-items:center; }
    .tab-content.active{ display:flex; }

    /* Info Styles */
    .info-container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 30px; } 
    .info-card { background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; gap: 30px; align-items: flex-start; }
    .info-text-area { flex: 1.2; }
    .info-visual-area { flex: 0.8; text-align: center; background: #f9f9f9; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; }
    .info-visual-area img { max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: block; }
    .info-visual-area .fallback-icon { display: none; color: #dfe6e9; font-size: 4rem; }
    .info-visual-area.error img { display: none; }
    .info-visual-area.error .fallback-icon { display: block; }
    .info-title { font-size: 1.5rem; font-weight: 700; color: var(--ikea-blue); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .info-desc { font-size: 1rem; color: #333; line-height: 1.6; }
    .bi-en { display: block; font-size: 0.85em; color: #777; font-weight: 300; margin-top: 3px; margin-bottom: 4px; }
    .color-box { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
    .cb-green { background: #d4edda; } .cb-yellow { background: #fff3cd; } .cb-red { background: #f8d7da; }

    /* Components */
    .status-badge{ display:inline-block; padding:4px 10px; border-radius:20px; font-size:.75rem; font-weight:bold; background:#fff3cd; color:#856404; white-space: nowrap; }
    .status-badge.connected{ background:#d4edda; color:#155724; }
    .status-badge.error{ background:#f8d7da; color:#721c24; }
    
    /* Buttons */
    .btn-export-csv { background-color: #217346; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: background 0.2s; }
    .btn-export-csv:hover { background-color: #1e6b3e; }
    .btn-copy { background-color: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: background 0.2s; }
    .btn-copy:hover { background-color: #e67e22; }

    /* Search Tab */
    .search-card{ background:#fff; padding:40px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,.05); width:100%; max-width:800px; text-align:left; }
    .search-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .search-title{ font-size:1.2rem; font-weight:600; color:var(--ikea-blue); display:flex; align-items:center; gap:6px; }
    .search-title .en-sub { margin-left: 5px; font-size: 0.8em; color: #777; font-weight: 300; }
    .input-wrapper{ display:flex; gap:10px; height:50px; }
    input[type="text"]{ flex-grow:1; padding:0 15px; border:1px solid #ccc; border-radius:4px; font-size:1rem; }
    .btn-search{ background:var(--ikea-blue); color:#fff; border:none; padding:0 25px; border-radius:4px; font-weight:700; cursor:pointer; font-size:1rem; white-space:nowrap; }
    .btn-scan-trigger{ display:none; background:#333; color:#fff; border:none; padding:0 15px; border-radius:4px; cursor:pointer; font-size:1.2rem; align-items:center; justify-content:center; }
    
    .helper-text { margin-top:15px; font-size:0.9rem; color:#555; line-height:1.6; }
    .mobile-only-tip { display: none; }

    .result-section{ width:100%; max-width:1200px; margin-top:30px; display:none; }
    .dashboard { display: flex; gap: 20px; margin-bottom: 30px; }
    .dash-card { flex: 1; background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid var(--ikea-blue); }
    .dash-card h3 { font-size: 2rem; margin: 10px 0 5px; } .dash-card p { font-size: 0.8rem; color: #888; }
    
    .date-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; text-align: center; width: 90px; }
    .date-badge.confirmed { background-color: #d4edda !important; color: #155724 !important; border: 1px solid #c3e6cb; }
    .date-badge.estimated { background-color: #fff3cd !important; color: #856404 !important; border: 1px solid #ffeeba; }
    .date-badge.tbd { background-color: #f8d7da !important; color: #721c24 !important; border: 1px solid #f5c6cb; }

    .item-link { color: var(--ikea-blue); text-decoration: none; cursor: pointer; font-weight: 700; transition: color 0.2s; }
    .item-link:hover { color: #003a6c; text-decoration: underline; }

    /* Pivot & Filter */
    .mobile-only-filters { display: none; }
    .pc-header-filter { display: block; width: 90%; padding: 4px; margin-top: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.8rem; text-align: center; }
    .always-visible-filter { display: block; width: 90%; padding: 4px; margin-top: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.8rem; text-align: center; }
    
    .pivot-container { width: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 0; box-sizing: border-box; height: 72vh; overflow: auto; position: relative; border: 1px solid #ddd; }
    .pivot-header-wrapper { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .pivot-table { min-width: 1600px; table-layout: fixed; border-collapse: separate; border-spacing: 0; }
    
    .pivot-table th { background-color: #f1f2f6; color: #333; padding: 12px 5px; border-right: 1px solid #ddd; border-bottom: 2px solid #ccc; font-size: 0.85rem; text-align: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; user-select: none; }
    .pivot-table th:hover { background-color: #e5e7eb; }
    .sort-icon { margin-left: 5px; color: #aaa; font-size: 0.8em; }
    .sort-icon.active { color: var(--ikea-blue); font-size: 0.9em; }

    .pivot-table td { padding: 8px 5px; border-right: 1px solid #eee; border-bottom: 1px solid #eee; font-size: 0.85rem; text-align: center; vertical-align: middle; }
    .pivot-table tbody tr:hover { background-color: #f9f9f9; }
    
    .col-hfb, .col-pa { width: 60px; }
    .col-itemno { width: 90px; }
    .col-itemname { width: 350px; text-align: left !important; padding-left: 10px !important; }
    .col-activity { width: 140px; }
    .not-fixed-col { width: 90px; background-color: #fff0f0; color: #c0392b; font-weight: bold; text-align: center; }
    .date-col { width: 75px; background-color: #fff; font-weight: bold; color: var(--ikea-blue); text-align: center; }
    .qty-cell { font-weight: bold; color: var(--ikea-blue); }

    .pivot-controls-right { display: flex; flex-direction: row; align-items: center; gap: 8px; }
    .empty-state { display: none; } 

    .filter-tray-container { width: 100%; background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); box-sizing: border-box; }
    .tray-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .tray-title { font-size: 0.9rem; color: #333; font-weight: 600; display:flex; align-items:center; gap:5px; }
    .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .filter-chip { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; user-select: none; background: #f8f9fa; border: 1px solid #ddd; color: #555; transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px; }
    .filter-chip.active { background-color: var(--ikea-blue); color: white; border-color: var(--ikea-blue); }
    .btn-clear-filter { background: none; border: 1px solid #ccc; border-radius: 4px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; color: #555; }

    .table-wrap { background: white; border-radius: 8px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    .pc-table-view th { background-color: #f9f9f9; padding: 15px; font-size: 0.8rem; color: #555; text-align: left; }
    .pc-table-view td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .mobile-result-view { display: none; }
    .product-summary-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 5px solid var(--ikea-yellow); }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
    .schedule-item { background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #ccc; margin-bottom:10px; }
    
    #loading { display: none; margin-top: 20px; color: var(--ikea-blue); text-align:center; }
    #scanner-modal { position: fixed; inset:0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
    #reader { width: 100%; max-width: 500px; background: black; border-radius: 8px; overflow: hidden; }
    .btn-modal { padding: 10px 20px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; background: white; }

    /* PRINT MODE */
    @media print {
        body, .app-container, .content-area { background: white !important; display: block !important; padding: 0 !important; margin: 0 !important; }
        header, .sidebar, .filter-tray-container, .mobile-only-filters, .pivot-controls-right, footer, .search-card, .dashboard, #stale-alert { display: none !important; }
        .pivot-container { height: auto !important; max-height: none !important; overflow: visible !important; border: none !important; box-shadow: none !important; }
        .pivot-table { width: 100% !important; min-width: auto !important; page-break-inside: auto; }
        .pivot-table tr { page-break-inside: avoid; page-break-after: auto; }
        .pivot-table th { position: static !important; box-shadow: none !important; border: 1px solid #000 !important; background-color: #eee !important; color: black !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .pivot-table td { border: 1px solid #000 !important; color: black !important; }
        .pivot-table input { display: none !important; } 
        a.item-link { text-decoration: none !important; color: black !important; }
        .pivot-header-area h2 { font-size: 1.5rem !important; color: black !important; text-align: center; margin-bottom: 20px !important; }
    }

    @media (max-width: 768px) {
      .app-container { flex-direction: column; display: block; }
      .sidebar { width: 100%; height: auto; flex-direction: row; padding-top: 0; }
      .nav-item { flex: 1; text-align: center; padding: 12px 5px; border-right: 1px solid #ddd; font-size: 0.95rem; white-space: nowrap; }
      .nav-sub { font-size: 0.7rem; }
      .content-area { padding: 15px 10px; }
      header { height: auto; padding: 15px; flex-direction: column; gap: 10px; align-items: center; }
      .header-left { width: 100%; align-items: center; }
      .main-title { font-size: 1.1rem; width: 100%; justify-content: center; white-space: nowrap; }
      .link-group { margin-left: 0; margin-top: 8px; width: 100%; overflow-x: auto; justify-content: flex-start; padding-bottom: 5px; }
      .header-right { width: 100%; align-items: center; flex-direction: row; justify-content: center; gap: 15px; margin-top: 5px; }
      
      .item-link { color: inherit !important; text-decoration: none !important; pointer-events: none !important; cursor: default !important; font-weight: bold; }
      .mobile-only-tip { display: block; margin-top: 10px; }

      .pivot-container { height: 60vh; padding: 0; border: 1px solid #ddd; }
      .pivot-table { min-width: auto; width: 100%; table-layout: auto; }
      .pivot-table th { position: sticky; top: 0; z-index: 100; }
      .info-card { flex-direction: column; padding: 20px; gap: 20px; } 
      .info-visual-area { min-height: 150px; order: 2; }
      .info-text-area { order: 1; }
      .search-card { padding: 20px; }
      .search-title { display: block; text-align: center; font-size: 1.1rem; }
      .search-title .en-sub { display: block; margin-left: 0; margin-top: 4px; font-size: 0.75rem; color: #999; }
      .btn-scan-trigger { display: flex; }
      .pc-table-view { display: none !important; } .mobile-result-view { display: block; }
      .dashboard { gap: 10px; } .dash-card { padding: 15px 5px; } .dash-card h3 { font-size: 1.3rem; }
      .pivot-header-area { flex-direction: row; justify-content: space-between; align-items: center; }
      .pivot-header-area h2 { font-size: 1.1rem; margin: 0; white-space: nowrap; }
      .pivot-header-area h2 .en-sub { display: none; }
      .pivot-controls-right { flex-direction: column; align-items: flex-end; gap: 5px; }
      .btn-export-csv, .btn-copy { padding: 4px 8px; font-size: 0.75rem; }
      .mobile-only-filters { display: flex; gap: 10px; background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .pf-group { display: flex; flex-direction: column; gap: 5px; flex: 1; justify-content: center; }
      .pf-label { font-size: 0.85rem; font-weight: 700; color: var(--ikea-blue); text-align: center; display: block; }
      .pf-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; text-align: center; width: 100%; box-sizing: border-box; }
      .pc-header-filter, .always-visible-filter { display: none; }
      .col-itemname { width: auto; min-width: 140px; }
      .col-itemno { width: 70px; font-size: 0.75rem; }
      .date-col, .not-fixed-col { width: auto; min-width: 60px; font-size: 0.75rem; }
      .empty-state { display: block; padding: 40px; text-align: center; color: #888; background: #f9f9f9; border-radius: 8px; border: 1px dashed #ccc; margin-top: 10px; }
      .filter-tray-container { padding: 10px; margin-bottom: 10px; }
      .tray-title { font-size: 0.8rem; }
      .filter-chip { padding: 4px 10px; font-size: 0.75rem; gap: 4px; }
      .chip-container { gap: 6px; }
    }
  </style>
</head>
<body>

  <div id="stale-alert">
    <i class="fas fa-exclamation-triangle"></i> 주의: 데이터가 3일(72시간) 이상 업데이트되지 않았습니다. (Updated > 72h ago)
  </div>

  <div id="scanner-modal">
    <div style="color:white; margin-bottom:10px; text-align:center;">
      <i class="fas fa-barcode"></i> 바코드에 카메라를 대주세요
    </div>
    <div id="reader"></div>
    <button class="btn-modal" onclick="stopScanner()" style="margin-top:20px;">닫기</button>
  </div>

  <header>
    <div class="header-left">
      <a href="." class="main-title"><i class="fas fa-truck-fast" style="color:var(--ikea-yellow);"></i> STO373 Goods Arrival Plan Search</a>
      <div class="link-group">
        <a href="https://coworker.ingka.com/kr/ko/v1/" target="_blank" class="header-sub-link"><i class="fas fa-external-link-alt"></i> SäljaPro</a>
        <a href="https://www.ikea.com/kr/ko/" target="_blank" class="header-sub-link"><i class="fas fa-home"></i> IKEA Home</a>
        <a href="https://mhs-373.ikea.com/gateway/" target="_blank" class="header-sub-link"><i class="fas fa-desktop"></i> MHS</a>
        <a href="https://piafacts.ikea.net/kr/en" target="_blank" class="header-sub-link"><i class="fas fa-info-circle"></i> PIA Facts</a>
      </div>
    </div>
    <div class="header-right">
      <span>Ver 8.0 Pro Edition</span>
      <div id="data-update-date" style="color:var(--ikea-yellow); font-weight:500;">data update : -</div>
    </div>
  </header>

  <div class="app-container">
    <nav class="sidebar">
      <div class="nav-item active" onclick="switchTab('info')" id="nav-info">Information <span class="nav-sub">사용 가이드</span></div>
      <div class="nav-item" onclick="switchTab('search')" id="nav-search">Article Search <span class="nav-sub">제품 검색</span></div>
      <div class="nav-item" onclick="switchTab('arrival')" id="nav-arrival">Goods Arrival <span class="nav-sub">도착 현황</span></div>
    </nav>

    <div class="content-area">
      <div id="tab-info" class="tab-content active">
        <div class="info-container">
            <div class="info-card" style="display:block; text-align:center;">
                <h1 style="color:var(--ikea-blue); margin-bottom:10px;">Welcome to STO373 Goods Arrival Tool</h1>
                <p style="color:#555;">이 도구는 제품의 도착 예정 정보를 쉽고 빠르게 조회하기 위해 만들어졌습니다.<br><span class="bi-en">This tool is designed to quickly and easily check product arrival schedules.</span></p>
                <div style="margin-top:20px; font-size:0.9rem; color:#666; background:#f0f2f5; padding:15px; border-radius:8px; display:inline-block; text-align:left;">
                    <ul style="margin:0; padding-left:20px;">
                        <li>데이터는 매 영업일 기준, <strong>오후 3~4시</strong> 사이에 업데이트 됩니다.<br><span class="bi-en" style="font-size:0.8em; color:#888;">Data is updated between 3 PM and 4 PM on business days.</span></li>
                        <li style="margin-top:8px;">데이터가 최종 업데이트 된 날짜는 우측 상단의 <strong>'data update'</strong> 날짜를 참고해주세요.<br><span class="bi-en" style="font-size:0.8em; color:#888;">Please refer to the 'data update' date at the top right.</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="info-card">
                <div class="info-text-area">
                    <div class="info-title"><i class="fas fa-search"></i> 1. Article Search</div>
                    <div class="info-desc">
                        <p><strong>제품번호를 검색합니다. (쉼표나 띄어쓰기로 여러 개 동시 검색 가능)</strong><br><span class="bi-en">Search multiple item numbers by separating them with spaces or commas.</span></p>
                        <p style="color:#e74c3c;">만약 제품번호가 잘못됐거나, OIP가 없다면 결과가 나오지 않습니다.<br><span class="bi-en">No results if incorrect item no or no OIP.</span></p>
                        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
                        <p><strong>Total</strong> : 총 배송될 계획 (예: 5 = 5개의 배송 계획)<br><span class="bi-en">Means the total number of delivery plans.</span></p>
                        <p><strong>Future Qty</strong> : 가장 가까운 미래에 입고될 수량<br><span class="bi-en">Means the quantity arriving in the nearest future.</span></p>
                        <div style="background:#f9f9f9; padding:10px; border-radius:4px; margin-top:10px;">
                            <div style="margin-bottom:5px;"><span class="color-box cb-green"></span> <strong>Green</strong> : 입고 확정<br><span class="bi-en" style="padding-left:17px;">Confirmed arrival.</span></div>
                            <div style="margin-bottom:5px;"><span class="color-box cb-yellow"></span> <strong>Yellow</strong> : 배송 미확정 (예상)<br><span class="bi-en" style="padding-left:17px;">Estimated arrival date.</span></div>
                            <div><span class="color-box cb-red"></span> <strong>Red</strong> : 출발 전 (미정)<br><span class="bi-en" style="padding-left:17px;">Not fixed (Before departure).</span></div>
                        </div>
                    </div>
                </div>
                <div class="info-visual-area" id="visual-search">
                    <img src="./Search.jpg" alt="Article Search Guide" onerror="this.parentElement.classList.add('error')">
                    <i class="fas fa-mobile-alt fallback-icon"></i><span class="fallback-icon" style="font-size:1rem; margin-top:10px;">Image Not Uploaded</span>
                </div>
            </div>
            
            <div class="info-card">
                <div class="info-text-area">
                    <div class="info-title"><i class="fas fa-calendar-alt"></i> 2. Goods Arrival</div>
                    <div class="info-desc">
                        <p><strong>필터 및 정렬 기능</strong><br>날짜, HFB, PA 등으로 필터링이 가능하며, 표의 제목(Header)을 클릭하면 <strong>오름차순/내림차순 정렬</strong>이 가능합니다.<br><span class="bi-en">Filter and sort data by clicking table headers.</span></p>
                        <p><strong>복사 및 엑셀 다운로드 (WYSIWYG)</strong><br>오른쪽 위 버튼을 통해 <strong>현재 화면에 필터링된 결과만</strong> 깔끔하게 복사하거나 엑셀로 다운받을 수 있습니다.<br><span class="bi-en">Copy or export currently filtered data only.</span></p>
                        <p><strong>인쇄 최적화 모드 지원</strong><br>Ctrl + P 를 누르시면 불필요한 메뉴 없이 표만 깔끔하게 인쇄됩니다.<br><span class="bi-en">Press Ctrl+P to print a clean table view.</span></p>
                    </div>
                </div>
                <div class="info-visual-area" id="visual-arrival">
                    <img src="./Arrival.jpg" alt="Goods Arrival Guide" onerror="this.parentElement.classList.add('error')">
                    <i class="fas fa-table fallback-icon"></i><span class="fallback-icon" style="font-size:1rem; margin-top:10px;">Image Not Uploaded</span>
                </div>
            </div>

            <div class="info-card" style="display:block; background:#f0f8ff; border:1px solid #d6eaf8;">
                <div class="info-title" style="margin-bottom:10px; color:#2c3e50; border:none;"><i class="fas fa-envelope"></i> Question & Request (문의사항)</div>
                <p style="margin:0; font-size:1rem; color:#555;">문의 및 요청사항이 있다면 언제든지 <a href="mailto:dl.fi.373@ingka.ikea.com" style="color:var(--ikea-blue); font-weight:bold;">dl.fi.373@ingka.ikea.com</a> 으로 메일 주세요. 감사합니다.<br><span class="bi-en">If you have any questions, please email us.</span></p>
            </div>

        </div>
      </div>

      <div id="tab-search" class="tab-content">
        <div class="search-card">
          <div class="search-header">
            <div class="search-title"><i class="fas fa-search"></i> 검색 (제품 번호)<span class="en-sub">Search Items</span></div>
            <div class="status-badge" id="statusBadge1"><i class="fas fa-spinner fa-spin"></i> 연결 중...</div>
          </div>
          <div class="input-wrapper">
            <input type="text" id="itemInput" placeholder="예: 80518273, 10271821"/>
            <button class="btn-scan-trigger" onclick="startScanner()"><i class="fas fa-camera"></i></button>
            <button class="btn-search" onclick="performSearch()">검색</button>
          </div>
          
          <div class="helper-text">
            <i class="fas fa-lightbulb" style="color:var(--ikea-yellow);"></i> <strong>Tip:</strong><br>
            <div style="margin-top:4px;">
                띄어쓰기나 쉼표(,)를 통해 <strong>여러 제품을 한 번에 검색</strong>할 수 있습니다. 제품번호 클릭 시 PIA Facts로 연결됩니다.<br>
                <span style="color:#888; font-size:0.95em;">You can search multiple items at once using spaces or commas (,). Clicking an item number redirects to PIA Facts.</span>
            </div>
            <div class="mobile-only-tip">
                모바일에서는 카메라 아이콘을 눌러 바코드를 자동으로 입력할 수 있습니다.<br>
                <span style="color:#888; font-size:0.95em;">On mobile, you can automatically enter the barcode by tapping the camera icon.</span>
            </div>
          </div>
          
          <div id="loading"><i class="fas fa-spinner fa-spin fa-2x"></i><br/>데이터 검색 중...</div>
        </div>
        <div id="resultSection" class="result-section">
          <div id="statusBar" class="status-msg"></div>
          <div class="dashboard">
            <div class="dash-card"><h3 id="totalResults">-</h3><p>Total</p></div>
            <div class="dash-card"><h3 id="futureDeliveryQty">0</h3><p>Future Qty</p></div>
            <div class="dash-card"><h3 id="nextDeliveryDate">-</h3><p>Next Date</p></div>
          </div>
          <div class="pc-table-view">
            <div class="table-wrap">
              <table><thead><tr><th>HFB</th><th>ITEM NO</th><th>ITEM NAME</th><th>SSD</th><th>EDS</th><th>PLANNED DATE</th><th>QTY</th><th>CONTAINER</th></tr></thead><tbody id="pcResultBody"></tbody></table>
            </div>
          </div>
          <div class="mobile-result-view">
            <div id="mobileProductSummary" class="product-summary-card"></div>
            <div id="mobileScheduleList" class="schedule-list"></div>
          </div>
        </div>
      </div>

      <div id="tab-arrival" class="tab-content">
        <div class="mobile-only-filters">
            <div class="pf-group"><label class="pf-label">HFB</label><input type="text" id="pf-hfb" class="pf-input" placeholder="All" onkeyup="debounceFilter()"></div>
            <div class="pf-group"><label class="pf-label">PA</label><input type="text" id="pf-pa" class="pf-input" placeholder="All" onkeyup="debounceFilter()"></div>
            <div class="pf-group"><label class="pf-label">Activity</label><input type="text" id="pf-activity" class="pf-input" placeholder="All" onkeyup="debounceFilter()"></div>
        </div>
        <div class="filter-tray-container">
          <div class="tray-header"><div class="tray-title"><i class="fas fa-filter"></i> Date Filter (Click to Toggle)</div><button class="btn-clear-filter" onclick="clearDateFilters()"><i class="fas fa-sync-alt"></i> Show All</button></div>
          <div class="chip-container" id="dateFilterChips"></div>
        </div>
        
        <div class="pivot-header-wrapper">
            <div class="pivot-header-area" style="margin-bottom:0;">
                <h2 style="color:var(--ikea-blue); margin:0;"><i class="fas fa-calendar-alt"></i> Goods Arrival<span class="en-sub" style="font-size:.6em; display:block; margin-left:0; margin-top:5px;">오늘부터 미래의 도착 예정 물량을 보여줍니다.</span></h2>
            </div>
            <div class="pivot-controls-right">
                <div class="status-badge" id="statusBadge2"><i class="fas fa-spinner fa-spin"></i> 연결 중...</div>
                <button class="btn-copy" onclick="copyToClipboard()"><i class="fas fa-copy"></i> Copy</button>
                <button class="btn-export-csv" onclick="exportToXlsx()"><i class="fas fa-file-excel"></i> Excel</button>
            </div>
        </div>

        <div class="pivot-container">
          <table class="pivot-table" id="pivotTable"><thead id="pivotHead"></thead><tbody id="pivotBody"></tbody></table>
          <div id="pivotEmptyState" class="empty-state">
              <i class="fas fa-search" style="font-size: 2rem; color:#ddd; margin-bottom:10px;"></i><br>
              상단의 <strong>HFB</strong>, <strong>PA</strong>를 입력하거나<br><strong>날짜</strong>를 선택하면 결과가 표시됩니다.
          </div>
          <div id="pivotLoading" style="display:none; text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <footer><strong>STO373 Tool</strong> — Automated FI</footer>

  <script>
    const GITHUB_OWNER = 'STO373-FI'; 
    const GITHUB_REPO = 'Goods-Arrival'; 
    const FALLBACK_FILE_URL = './STO373 Goods arrival plan.xlsx'; 

    let rawRows = []; let data = []; let html5QrcodeScanner = null;
    let allPivotRows = []; let displayedPivotRows = []; let globalSortedDates = [];
    let selectedDateFilters = new Set(); 
    let lastRenderedDateColumns = ""; 

    let currentSortCol = null;
    let currentSortAsc = true;
    
    let exportVisibleDates = [];
    let exportShowNotFixed = true;

    const ALIASES = {
      ItemNo: ['ItemNo','ITEM NO','ARTNO','ITEMNO'],
      ItemName: ['ItemName','ITEM NAME','ARTNAME','ARTNAME_UNICODE','ITEMNAME'],
      PA: ['PA'],
      HFB: ['HFB'],
      SSD: ['SSD'],
      EDS: ['EDS'],
      PlannedReceivingDate: ['Planned Receiving Date','PLANNED RECEIVING DATE','PLANNED DATE','PlannedDate'],
      Port: ['Port','PORT','LatestRcvDate','LATESTRCVDATE'],
      ArrivalDate: ['Arrival Date','Arrival','ARRIVAL'],
      LatestQty: ['LatestQty','LATESTQTY','QTY','Quantity'],
      Container: ['Container','CONTAINER','ContainerNo','Container No'],
      Activity: ['Activity & offer','Activity','Activity & Offer','ACTIVITY & OFFER'],
      Status: ['Status', 'STATUS', 'Main Status', 'Stat']
    };

    const debounce = (fn, t=300) => { let tm; return (...a)=>{clearTimeout(tm); tm=setTimeout(()=>fn(...a), t);} };
    const safeNum = v => Number.isFinite(+v) ? +v : 0;
    const pad2 = n => String(n).padStart(2,'0');
    const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    function getWeekNumber(d){
      const target = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNr = (target.getUTCDay() + 6) % 7; 
      target.setUTCDate(target.getUTCDate() - dayNr + 3); 
      const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
      return 1 + Math.round((target - firstThursday) / (7*24*3600*1000));
    }
    function normKey(s){ return String(s||'').toLowerCase().replace(/[\s_\\/-]+/g,'').replace(/[^\w]/g,''); }
    function findColIndex(header, candidates){
      if(!header || !header.length) return -1;
      const normHeader = header.map(h => normKey(h));
      for (const c of candidates){ if (normHeader.indexOf(normKey(c)) !== -1) return normHeader.indexOf(normKey(c)); }
      for (let i=0;i<header.length;i++){ for (const c of candidates){ if (normHeader[i].includes(normKey(c))) return i; } }
      return -1;
    }
    function buildColumnMap(header){ const map = {}; for (const k of Object.keys(ALIASES)){ map[k] = findColIndex(header, ALIASES[k]); } return map; }
    function excelToDate(v){
      if(!v && v!==0) return null;
      if (typeof v === 'number'){
        if(v > 10000 && v < 60000){ return isNaN(new Date(Math.round((v - 25569) * 86400 * 1000) + 43200000)) ? null : new Date(Math.round((v - 25569) * 86400 * 1000) + 43200000); }
        if (v >= 19000101 && v <= 29991231){ const s = String(v); return new Date(`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}T00:00:00`); }
      }
      if (typeof v === 'string'){ const s = v.trim(); if (/^\d{8}$/.test(s)){ return new Date(`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}T00:00:00`); } return new Date(s); }
      if (v instanceof Date) return v;
      return null;
    }

    function formatItemLink(itemNo) {
        const raw = String(itemNo).trim();
        const cleanNo = raw.replace(/[^0-9]/g, '');
        if(cleanNo.length > 0) {
            const paddedNo = cleanNo.padStart(8, '0');
            return `<a href="https://piafacts.ikea.net/kr/en/${paddedNo}" target="_blank" class="item-link" onclick="event.stopPropagation();">${raw}</a>`;
        }
        return `<b>${raw}</b>`;
    }

    window.onload = async function(){
      try{
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        
        if (!urlParams.has('hfb')) {
            const savedHfb = localStorage.getItem('last_hfb');
            if (savedHfb) { if(document.getElementById('pf-hfb')) document.getElementById('pf-hfb').value = savedHfb; }
        } else {
            if(document.getElementById('pf-hfb')) document.getElementById('pf-hfb').value = urlParams.get('hfb') || '';
            if(document.getElementById('pf-pa')) document.getElementById('pf-pa').value = urlParams.get('pa') || '';
        }

        const fileUrl = await fetchLatestExcelUrl();
        const resp = await fetch(fileUrl);
        const headerDateStr = resp.headers.get('Last-Modified');
        if (!resp.ok) throw new Error('Excel file not found');
        const buf = await resp.arrayBuffer();
        
        const wb = XLSX.read(buf, { type:'array', cellDates: true, sheets: 0, dense: true, cellStyles: false, cellImages: false });
        
        let finalDate = null;
        if (wb.Props && wb.Props.ModifiedDate) finalDate = new Date(wb.Props.ModifiedDate);
        else if (headerDateStr) finalDate = new Date(headerDateStr);
        if (finalDate) {
            document.getElementById('data-update-date').innerText = `data update : ${ymd(finalDate)}`;
            const diffHours = (new Date() - finalDate) / (1000 * 60 * 60);
            if (diffHours > 72) {
                document.getElementById('stale-alert').style.display = 'block';
            }
        }

        const ws = wb.Sheets[wb.SheetNames[0]];
        if (ws["!ref"]) {
          const range = XLSX.utils.decode_range(ws['!ref']);
          ws['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: range.e.r, c: range.e.c } });
        }
        const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: true, blankRows: false, range: 0 });
        const rawHeader = (json[0] || []).map(x=>String(x).trim());
        rawRows = json.slice(1);
        const COL = buildColumnMap(rawHeader);

        data = rawRows.map(r => ({
          itemNo: String(r[COL.ItemNo] ?? '').trim(),
          itemName: r[COL.ItemName] ?? '',
          pa: r[COL.PA] ?? '',
          hfb: r[COL.HFB] ?? '',
          ssd: r[COL.SSD] ?? '',
          eds: r[COL.EDS] ?? '',
          plannedDate: r[COL.PlannedReceivingDate],
          portDate: r[COL.Port],
          arrivalDate: r[COL.ArrivalDate],
          qty: safeNum(r[COL.LatestQty]),
          container: String(r[COL.Container] ?? '').trim(),
          activity: r[COL.Activity] ?? '',
          status: r[COL.Status] ?? ''
        }));
        
        updateStatus('connected');
        
        if (tabParam === 'arrival') {
            switchTab('arrival');
        } else if (tabParam === 'search') {
            switchTab('search');
            if (urlParams.has('itemNo')) {
                document.getElementById('itemInput').value = urlParams.get('itemNo');
                performSearch();
            }
        }

      } catch (error) { console.error(error); updateStatus('error'); }
    };

    async function fetchLatestExcelUrl() {
        if (GITHUB_OWNER === 'YOUR_GITHUB_ID') return FALLBACK_FILE_URL; 
        try {
            const apiUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/`;
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("API Error");
            const files = await response.json();
            const targetFiles = files.filter(f => f.name.toLowerCase().startsWith("order followup functions") && f.name.toLowerCase().endsWith(".xlsx"));
            if (targetFiles.length === 0) return FALLBACK_FILE_URL;
            targetFiles.sort((a, b) => b.name.localeCompare(a.name));
            return targetFiles[0].download_url;
        } catch (e) { return FALLBACK_FILE_URL; }
    }

    function updateStatus(status) {
      const b1 = document.getElementById('statusBadge1'); const b2 = document.getElementById('statusBadge2');
      if (status === 'connected') { b1.innerHTML = `<i class="fas fa-check-circle"></i>`; b1.className = 'status-badge connected'; b2.innerHTML = `<i class="fas fa-check-circle"></i>`; b2.className = 'status-badge connected'; } 
      else { b1.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`; b1.className = 'status-badge error'; b2.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`; b2.className = 'status-badge error'; }
    }

    function switchTab(tabName) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById('nav-' + tabName).classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
      if (tabName === 'arrival') { 
          if (allPivotRows.length > 0) updateTableDisplay(); 
          else if (data.length > 0) processPivotData(data); 
      }
    }

    document.getElementById('itemInput').addEventListener('keypress', e => { if (e.key==='Enter') performSearch(); });
    
    function performSearch() {
      const raw = document.getElementById('itemInput').value.trim();
      if (!raw) { alert("제품번호를 입력해주세요."); return; }
      localStorage.setItem('last_search_item', raw);
      
      const targets = raw.split(/[\s,]+/).map(t => t.replace(/[^0-9A-Za-z]/g,'').toLowerCase()).filter(t => t);
      if (targets.length === 0) return;

      document.getElementById('loading').style.display = 'block'; document.getElementById('resultSection').style.display = 'none';
      setTimeout(() => { const results = searchData(targets); displayResults(results); document.getElementById('loading').style.display = 'none'; }, 300);
    }
    
    function determinePlanned(row){
      const pd = excelToDate(row.plannedDate); const today = new Date(); today.setHours(0,0,0,0);
      if (pd){ 
          const dd = new Date(pd); dd.setHours(0,0,0,0); 
          if (dd >= today) return { type:'confirmed', dateObj: dd, label: `<span class="date-badge confirmed">${ymd(dd)}</span>` }; 
      }

      const status = String(row.status || "").toUpperCase();
      const container = String(row.container || "").trim();
      const port = excelToDate(row.portDate); 

      if (status.includes("DISPATCHED") && container && container.length > 0 && container !== "배송준비중") {
          if (port) {
              const est = addDays(port, 7); 
              const wk = getWeekNumber(est); 
              return { type:'estimated', dateObj: null, label: `<span class="date-badge estimated">WK${wk} 예상</span>` };
          }
      }
      return { type:'tbd', dateObj: null, label: `<span class="date-badge tbd">미정</span>` };
    }

    function searchData(targets){
      const grouped = new Map(); const today = new Date(); today.setHours(0,0,0,0);
      data.forEach(row => {
        const itemNo = String(row.itemNo||'').replace(/\s+/g,'').toLowerCase();
        const cont = String(row.container||'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase();
        
        if (targets.some(t => (itemNo && itemNo.includes(t)) || (cont && cont.includes(t)))) {
            const plan = determinePlanned(row);
            if (plan.type === 'confirmed') {
                const d = excelToDate(row.plannedDate);
                if (d && new Date(d) < today) return; 
            }
            const container = row.container || '배송준비중'; 
            const keyStr = plan.type === 'confirmed' ? ymd(plan.dateObj) : (plan.type === 'estimated' ? 'WK_EST' : 'TBD');
            const key = `${row.itemNo}__${container}__${keyStr}`; 
            
            const qty = safeNum(row.qty);
            if (grouped.has(key)){ grouped.get(key).quantity += qty; } 
            else { 
                grouped.set(key, { 
                    hfb: row.hfb, itemNo: row.itemNo, itemName: row.itemName, ssdRaw: row.ssd, edsRaw: row.eds, 
                    plannedDateStr: plan.label, 
                    plannedDateObj: plan.type==='confirmed' ? plan.dateObj : null, 
                    quantity: qty, container 
                }); 
            }
        }
      });
      return Array.from(grouped.values());
    }

    function displayResults(results) {
      const resultSection = document.getElementById('resultSection'); const statusBar = document.getElementById('statusBar'); const pcTbody = document.getElementById('pcResultBody'); const mobileScheduleList = document.getElementById('mobileScheduleList'); const mobileProductSummary = document.getElementById('mobileProductSummary');
      resultSection.style.display = 'block'; pcTbody.innerHTML = ''; mobileScheduleList.innerHTML = ''; mobileProductSummary.innerHTML = '';
      
      if (results.length === 0) { statusBar.innerHTML = `검색 결과가 없습니다.`; statusBar.className = 'status-msg status-fail'; document.querySelector('.dashboard').style.display = 'none'; return; }
      statusBar.innerHTML = `${results.length}개의 배송 계획 발견!`; statusBar.className = 'status-msg status-success'; document.querySelector('.dashboard').style.display = 'flex';
      
      document.getElementById('totalResults').innerText = results.length;
      results.sort((a, b) => {
          if (a.itemNo !== b.itemNo) return a.itemNo.localeCompare(b.itemNo);
          return (a.plannedDateObj || new Date(9999,0,1)) - (b.plannedDateObj || new Date(9999,0,1));
      });

      const future = results.filter(r => r.plannedDateObj !== null);
      if (future.length > 0) { 
          const nextDateObj = future.reduce((min, p) => p.plannedDateObj < min ? p.plannedDateObj : min, future[0].plannedDateObj);
          const nextDateStr = ymd(nextDateObj);
          const totalNext = future.filter(r => ymd(r.plannedDateObj) === nextDateStr).reduce((s, i) => s + i.quantity, 0); 
          document.getElementById('futureDeliveryQty').innerText = totalNext; 
          document.getElementById('nextDeliveryDate').innerText = nextDateStr; 
      } else { 
          document.getElementById('futureDeliveryQty').innerText = "0"; document.getElementById('nextDeliveryDate').innerText = "-"; 
      }
      
      results.forEach(row => {
        pcTbody.innerHTML += `<tr><td>${row.hfb}</td><td>${formatItemLink(row.itemNo)}</td><td>${row.itemName}</td><td>${parseExcelDate(row.ssdRaw)}</td><td>${parseExcelDate(row.edsRaw)}</td><td>${row.plannedDateStr}</td><td class="qty-cell">${row.quantity}</td><td>${row.container}</td></tr>`;
      });
      if(results.length > 0) {
        mobileProductSummary.innerHTML = `<div class="summary-row"><span class="label">결과</span> <span class="value" style="font-size:1.2rem; color:var(--ikea-blue);">${results.length} 건</span></div>`;
        results.forEach(row => { mobileScheduleList.innerHTML += `<div class="schedule-item"><div style="font-weight:bold; margin-bottom:5px;">${row.itemNo}</div><div class="schedule-date">${row.plannedDateStr}</div><div class="schedule-details"><div class="schedule-qty">${row.quantity} ea</div><div class="schedule-container"><i class="fas fa-box"></i> ${row.container}</div></div></div>`; });
      }
    }

    function processPivotData(list, shouldRender = true) {
      const today = new Date(); today.setHours(0,0,0,0);
      const pivotMap = {}; const uniqueDates = new Set(); let hasNotFixed = false;

      list.forEach(row => {
        if (!row.itemNo) return;
        const pd = excelToDate(row.plannedDate); const qty = safeNum(row.qty);
        if (!pivotMap[row.itemNo]) { pivotMap[row.itemNo] = { hfb: row.hfb||"", pa: row.pa||"", itemNo: row.itemNo, itemName: row.itemName||"", activity: row.activity||"", dates: {}, notFixedQty: 0 }; }
        if (pd) {
          const dd = new Date(pd); dd.setHours(0,0,0,0);
          if (dd >= today) { const pStr = ymd(dd); pivotMap[row.itemNo].dates[pStr] = (pivotMap[row.itemNo].dates[pStr]||0) + qty; uniqueDates.add(pStr); }
        } else { pivotMap[row.itemNo].notFixedQty += qty; hasNotFixed = true; }
      });

      globalSortedDates = Array.from(uniqueDates).sort();
      renderDateFilterChips(globalSortedDates, hasNotFixed);

      allPivotRows = Object.values(pivotMap).sort((a, b) => {
        if (a.hfb !== b.hfb) return String(a.hfb).localeCompare(String(b.hfb));
        return String(a.pa).localeCompare(String(b.pa));
      });

      if(shouldRender) updateTableDisplay();
    }

    function renderDateFilterChips(dates, hasNotFixed) {
      const container = document.getElementById('dateFilterChips'); container.innerHTML = ''; 
      const createChip = (val, label) => {
        const div = document.createElement('div'); div.className = 'filter-chip';
        if(selectedDateFilters.has(val)) div.classList.add('active');
        div.innerHTML = `<i class="fas fa-calendar-check"></i> ${label}`;
        div.onclick = () => { if(selectedDateFilters.has(val)) { selectedDateFilters.delete(val); div.classList.remove('active'); } else { selectedDateFilters.add(val); div.classList.add('active'); } filterPivot(); };
        return div;
      };
      if(hasNotFixed) container.appendChild(createChip('Not Fixed', 'Not Fixed (미정)'));
      dates.forEach(d => container.appendChild(createChip(d, d)));
    }

    function clearDateFilters() { selectedDateFilters.clear(); document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); filterPivot(); }
    function debounceFilter() { 
        const hfb = document.getElementById('pf-hfb')?.value || document.getElementById('hfb-filter')?.value;
        if(hfb) localStorage.setItem('last_hfb', hfb);
        debounce(filterPivot, 400)(); 
    }

    function filterPivot() { updateTableDisplay(); }
    
    function sortTable(col) {
        if (currentSortCol === col) {
            currentSortAsc = !currentSortAsc;
        } else {
            currentSortCol = col;
            currentSortAsc = true;
        }
        updateTableDisplay();
    }
    
    function getSortIcon(col) {
        if (currentSortCol !== col) return '<i class="fas fa-sort sort-icon"></i>';
        return currentSortAsc ? '<i class="fas fa-sort-up sort-icon active"></i>' : '<i class="fas fa-sort-down sort-icon active"></i>';
    }

    function updateTableDisplay() {
      const isMobile = window.innerWidth <= 768;
      
      const pfHfb = document.getElementById('pf-hfb').value.trim().toUpperCase();
      const pfPa = document.getElementById('pf-pa').value.trim().toUpperCase();
      const pfActivity = document.getElementById('pf-activity').value.trim().toUpperCase();

      const headerHfbEl = document.getElementById('hfb-filter');
      const headerPaEl = document.getElementById('pa-filter');
      const headerActivityEl = document.querySelector('input[data-field="activity"]');
      
      const headerHfb = headerHfbEl ? headerHfbEl.value.trim().toUpperCase() : "";
      const headerPa = headerPaEl ? headerPaEl.value.trim().toUpperCase() : "";
      const headerActivity = headerActivityEl ? headerActivityEl.value.trim().toUpperCase() : "";
      
      const hfbVal = isMobile ? pfHfb : headerHfb;
      const paVal = isMobile ? pfPa : headerPa;
      const activityVal = isMobile ? pfActivity : headerActivity;

      const hasDateFilter = selectedDateFilters.size > 0;

      if (isMobile) {
          const isEmpty = (!hfbVal && !paVal && !activityVal && !hasDateFilter);
          document.getElementById('pivotEmptyState').style.display = isEmpty ? 'block' : 'none';
          document.getElementById('pivotTable').style.display = isEmpty ? 'none' : 'table';
          if(isEmpty) return;
      } else {
          document.getElementById('pivotEmptyState').style.display = 'none';
          document.getElementById('pivotTable').style.display = 'table';
      }

      let visibleDates;
      if (hasDateFilter) {
          visibleDates = globalSortedDates.filter(d => selectedDateFilters.has(d));
      } else {
          visibleDates = [...globalSortedDates];
      }
      
      const showNotFixed = (!hasDateFilter) || (selectedDateFilters.has('Not Fixed'));
      
      exportVisibleDates = visibleDates;
      exportShowNotFixed = showNotFixed;

      const newHeaderSignature = visibleDates.join('|') + (showNotFixed ? '|NF' : '') + (isMobile ? '|M' : '|P') + `|Sort:${currentSortCol}:${currentSortAsc}`;
      
      if (newHeaderSignature !== lastRenderedDateColumns) {
          let theadHtml = `<tr>
            <th class="col-hfb" onclick="sortTable('hfb')">HFB ${getSortIcon('hfb')}<br><input id="hfb-filter" type="text" class="pc-header-filter" placeholder="Filter" onkeyup="debounceFilter()" onclick="event.stopPropagation()"></th>
            <th class="col-pa" onclick="sortTable('pa')">PA ${getSortIcon('pa')}<br><input id="pa-filter" type="text" class="pc-header-filter" placeholder="Filter" onkeyup="debounceFilter()" onclick="event.stopPropagation()"></th>
            <th class="col-itemno" onclick="sortTable('itemNo')">Item No ${getSortIcon('itemNo')}<br><input data-field="itemNo" class="always-visible-filter" placeholder="Filter" onkeyup="debounceFilter()" onclick="event.stopPropagation()"></th>
            <th class="col-itemname" onclick="sortTable('itemName')">Item Name ${getSortIcon('itemName')}<br><input data-field="itemName" class="pc-header-filter" placeholder="Filter" onkeyup="debounceFilter()" onclick="event.stopPropagation()"></th>
            <th class="col-activity" onclick="sortTable('activity')">Activity ${getSortIcon('activity')}<br><input data-field="activity" class="pc-header-filter" placeholder="Filter" onkeyup="debounceFilter()" onclick="event.stopPropagation()"></th>`;
          
          if(showNotFixed) theadHtml += `<th class="not-fixed-col" onclick="sortTable('Not Fixed')">미정<br>(Not Fixed) ${getSortIcon('Not Fixed')}</th>`;
          visibleDates.forEach(d => { 
              theadHtml += `<th class="date-col" onclick="sortTable('${d}')">${d} ${getSortIcon(d)}</th>`; 
          });
          theadHtml += `</tr>`;
          document.getElementById('pivotHead').innerHTML = theadHtml;
          lastRenderedDateColumns = newHeaderSignature;
          
          if (!isMobile) {
              if(document.getElementById('hfb-filter')) document.getElementById('hfb-filter').value = hfbVal;
              if(document.getElementById('pa-filter')) document.getElementById('pa-filter').value = paVal;
              const actInput = document.querySelector('input[data-field="activity"]');
              if(actInput) actInput.value = activityVal;
          }
      }

      const itemNoVal = document.querySelector('input[data-field="itemNo"]')?.value.trim().toUpperCase() || "";
      const itemNameVal = document.querySelector('input[data-field="itemName"]')?.value.trim().toUpperCase() || "";
      
      const filteredRows = allPivotRows.filter(row => {
        if (hfbVal && String(row.hfb).toUpperCase() !== hfbVal) return false;
        if (paVal && String(row.pa).toUpperCase() !== paVal) return false;
        if (itemNoVal && String(row.itemNo).toUpperCase().indexOf(itemNoVal) === -1) return false;
        if (itemNameVal && String(row.itemName).toUpperCase().indexOf(itemNameVal) === -1) return false;
        if (activityVal && String(row.activity || "").toUpperCase().indexOf(activityVal) === -1) return false;

        if (hasDateFilter) {
            let hasValueInSelected = false;
            if (selectedDateFilters.has('Not Fixed') && row.notFixedQty > 0) {
                hasValueInSelected = true;
            }
            if (!hasValueInSelected) {
                for (const dateKey of selectedDateFilters) {
                    if (dateKey === 'Not Fixed') continue;
                    if (row.dates[dateKey] > 0) {
                        hasValueInSelected = true;
                        break;
                    }
                }
            }
            if (!hasValueInSelected) return false;
        }
        return true;
      });

      if (currentSortCol) {
          filteredRows.sort((a, b) => {
              let valA, valB;
              if (currentSortCol === 'itemNo') { valA = String(a.itemNo); valB = String(b.itemNo); }
              else if (currentSortCol === 'itemName') { valA = String(a.itemName); valB = String(b.itemName); }
              else if (currentSortCol === 'hfb') { valA = String(a.hfb); valB = String(b.hfb); }
              else if (currentSortCol === 'pa') { valA = String(a.pa); valB = String(b.pa); }
              else if (currentSortCol === 'activity') { valA = String(a.activity); valB = String(b.activity); }
              else if (currentSortCol === 'Not Fixed') { valA = a.notFixedQty || 0; valB = b.notFixedQty || 0; }
              else { valA = a.dates[currentSortCol] || 0; valB = b.dates[currentSortCol] || 0; }

              const numA = parseFloat(valA); const numB = parseFloat(valB);
              if (!isNaN(numA) && !isNaN(numB)) {
                  return currentSortAsc ? numA - numB : numB - numA;
              }

              if (valA < valB) return currentSortAsc ? -1 : 1;
              if (valA > valB) return currentSortAsc ? 1 : -1;
              return 0;
          });
      }

      displayedPivotRows = filteredRows;

      let tbodyHtml = "";
      const count = Math.min(filteredRows.length, 3000);
      for(let i=0; i<count; i++) {
        const r = filteredRows[i];
        const nfVal = (showNotFixed && r.notFixedQty > 0) ? r.notFixedQty : "";
        tbodyHtml += `<tr><td class="col-hfb">${r.hfb}</td><td class="col-pa">${r.pa}</td><td class="col-itemno">${formatItemLink(r.itemNo)}</td><td class="col-itemname">${r.itemName}</td><td class="col-activity mobile-hidden">${r.activity}</td>`;
        if(showNotFixed) tbodyHtml += `<td class="not-fixed-col">${nfVal}</td>`;
        visibleDates.forEach(d => { tbodyHtml += `<td class="qty-cell">${r.dates[d] || ""}</td>`; });
        tbodyHtml += `</tr>`;
      }
      document.getElementById('pivotBody').innerHTML = tbodyHtml;
    }

    function exportToXlsx() {
        if (!displayedPivotRows || displayedPivotRows.length === 0) { alert("No data to export"); return; }
        
        const header = ["HFB", "PA", "Item No", "Item Name", "Activity"];
        if (exportShowNotFixed) header.push("Not Fixed");
        exportVisibleDates.forEach(d => header.push(d));
        
        const data = [header];
        displayedPivotRows.forEach(row => {
            const rowData = [row.hfb, row.pa, row.itemNo, row.itemName, row.activity];
            if (exportShowNotFixed) rowData.push(row.notFixedQty || "");
            exportVisibleDates.forEach(d => rowData.push(row.dates[d] || ""));
            data.push(rowData);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Filtered_Arrival");
        XLSX.writeFile(wb, `${ymd(new Date())}_filtered_export.xlsx`);
    }

    function copyToClipboard() {
        if (!displayedPivotRows || displayedPivotRows.length === 0) { alert("복사할 데이터가 없습니다."); return; }
        
        let tsv = ["HFB", "PA", "Item No", "Item Name", "Activity"];
        if (exportShowNotFixed) tsv.push("Not Fixed");
        exportVisibleDates.forEach(d => tsv.push(d));
        tsv = tsv.join("\t") + "\n";
        
        displayedPivotRows.forEach(row => {
            let rowData = [row.hfb, row.pa, row.itemNo, row.itemName, row.activity];
            if (exportShowNotFixed) rowData.push(row.notFixedQty || "");
            exportVisibleDates.forEach(d => rowData.push(row.dates[d] || ""));
            tsv += rowData.join("\t") + "\n";
        });
        
        navigator.clipboard.writeText(tsv).then(() => {
            alert("✅ 현재 필터링된 데이터가 클립보드에 복사되었습니다. 메신저나 엑셀에 붙여넣기(Ctrl+V) 하세요!");
        }).catch(err => {
            alert("복사에 실패했습니다. 브라우저 설정을 확인해주세요.");
        });
    }

    function parseExcelDate(value) {
        const d = excelToDate(value);
        return d ? ymd(d) : '-';
    }

    function startScanner() { document.getElementById('scanner-modal').style.display = 'flex'; if(!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("reader"); html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 300, height: 150 }, aspectRatio: 1.0 }, onScanSuccess).catch(e=>alert("Camera Error")); }
    function onScanSuccess(t) { document.getElementById('itemInput').value = t.replace(/[^0-9]/g, ''); stopScanner(); performSearch(); }
    function stopScanner() { if(html5QrcodeScanner) html5QrcodeScanner.stop().then(()=>document.getElementById('scanner-modal').style.display='none'); else document.getElementById('scanner-modal').style.display='none'; }
  </script>
</body>
</html>
