<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STO373 Goods Arrival Plan Search</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet"/>

  <style>
    :root { --ikea-blue:#0058a3; --ikea-yellow:#ffdb00; --bg-color:#f5f7f8; --text-dark:#111; --sidebar-width:250px; }
    body { font-family:'Noto Sans KR','Roboto',sans-serif; background-color:var(--bg-color); margin:0; padding:0; color:var(--text-dark); display:flex; flex-direction:column; min-height:100vh; }

    /* Header */
    header { background-color:var(--ikea-blue); color:#fff; padding:0 40px; height:100px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:2000; width:100%; box-sizing:border-box; flex-shrink:0; }
    .header-left{ display:flex; flex-direction:column; justify-content:center; align-items:flex-start; }
    .main-title{ color:#fff; text-decoration:none; font-size:1.4rem; font-weight:700; display:flex; align-items:center; gap:10px; transition:opacity .2s; }
    .main-title:hover{ opacity:.8; text-decoration:underline; }
    .link-group{ display:flex; gap:20px; margin-top:5px; margin-left:38px; flex-wrap:wrap; }
    .header-sub-link{ color:var(--ikea-yellow); text-decoration:none; font-weight:500; font-size:.95rem; font-family:'Roboto',sans-serif; display:flex; align-items:center; gap:5px; transition:opacity .2s; }
    .header-sub-link:hover{ opacity:.8; text-decoration:underline; }
    .header-right{ text-align:right; font-size:.75rem; line-height:1.3; opacity:.9; }

    /* Container */
    .app-container{ display:flex; flex:1; width:100%; overflow:hidden; }
    .sidebar{ width:var(--sidebar-width); background:#95a5a6; color:#fff; display:flex; flex-direction:column; flex-shrink:0; padding-top:20px; }
    .nav-item{ padding:15px 20px; cursor:pointer; transition:all .2s; font-size:1.1rem; border-bottom:1px solid rgba(255,255,255,.1); }
    .nav-item:hover{ background:rgba(255,255,255,.1); }
    .nav-item.active{ background:#fff; color:var(--ikea-blue); font-weight:bold; border-left:6px solid var(--ikea-yellow); }
    .nav-sub{ font-size:.8rem; opacity:.7; display:block; font-weight:300; margin-top:2px; }
    .content-area{ flex:1; padding:40px; overflow-y:auto; background:var(--bg-color); }
    .tab-content{ display:none; width:100%; flex-direction:column; align-items:center; }
    .tab-content.active{ display:flex; }

    /* Badges */
    .status-badge{ display:inline-block; padding:5px 12px; border-radius:20px; font-size:.8rem; font-weight:bold; background:#fff3cd; color:#856404; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .status-badge.connected{ background:#d4edda; color:#155724; }
    .status-badge.error{ background:#f8d7da; color:#721c24; }

    /* --- Multi-Select Date Filter (New) --- */
    .filter-tray-container {
      width: 100%; max-width: 100%; background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); box-sizing: border-box;
    }
    .tray-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .tray-title { font-size: 0.9rem; color: #333; font-weight: 600; display:flex; align-items:center; gap:5px; }
    .btn-clear-filter {
      background: none; border: 1px solid #ccc; border-radius: 4px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; color: #555;
    }
    .btn-clear-filter:hover { background: #f0f0f0; }

    .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .filter-chip {
      padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; user-select: none;
      background: #f8f9fa; border: 1px solid #ddd; color: #555; 
      transition: all 0.15s ease-in-out;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .filter-chip:hover { background: #e9ecef; border-color: #ccc; }
    
    /* Active State (Selected) */
    .filter-chip.active { 
      background-color: var(--ikea-blue); 
      color: white; 
      border-color: var(--ikea-blue); 
      box-shadow: 0 2px 4px rgba(0,88,163,0.3);
    }
    .filter-chip i { font-size: 0.8em; }
    .filter-chip.active i { color: var(--ikea-yellow); }

    /* Pivot Table */
    .col-hfb { width: 50px; min-width: 50px; max-width: 50px; text-align: center; }
    .col-pa { width: 50px; min-width: 50px; max-width: 50px; text-align: center; }
    .col-itemno { width: 100px; min-width: 100px; }
    .col-itemname { min-width: 350px; max-width: 500px; white-space: normal; word-break: break-word; }
    .col-activity { min-width: 120px; }
    .not-fixed-col { background-color: #fff0f0; color: #c0392b; font-weight: bold; min-width: 80px; text-align: center; }
    .date-col { background-color: #fff; min-width: 85px; font-weight: bold; color: var(--ikea-blue); text-align: center; }
    
    .pivot-container { width: 100%; overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 20px; box-sizing: border-box; }
    .pivot-table { width: 100%; border-collapse: collapse; min-width: 1200px; table-layout: fixed; }
    .pivot-table th { background-color: #f1f2f6; color: #333; padding: 10px 5px; border: 1px solid #ddd; font-size: 0.85rem; text-align: center; position: sticky; top: 0; z-index: 10; vertical-align: top; }
    .pivot-table td { padding: 8px 5px; border: 1px solid #eee; font-size: 0.85rem; text-align: center; vertical-align: middle; }
    .pivot-table tbody tr:hover { background-color: #f9f9f9; }
    .qty-cell { font-weight: bold; color: var(--ikea-blue); }

    .filter-input { width: 90%; padding: 4px; margin-top: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.8rem; text-align: center; }
    .filter-input:focus { border-color: var(--ikea-blue); outline: none; background-color: #f0f8ff; }

    /* Common */
    .table-wrap { background: white; border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; }
    .date-confirmed{ color:#27ae60; font-weight:bold; }
    .date-estimated{ color:#d35400; font-weight:bold; font-size:.9em; background:#ffeaa7; padding:2px 6px; border-radius:4px; }
    .limit-warning{ text-align:center; padding:10px; color:#7f8c8d; font-size:.85rem; background:#f9f9f9; border-top:1px solid #eee; }
    
    .en-sub { font-size: 0.75em; color: #777; font-weight: 300; margin-left: 6px; font-family: 'Roboto', sans-serif; }
    .en-block { display: block; font-size: 0.85em; color: #888; margin-top: 3px; font-weight: 300; font-family: 'Roboto', sans-serif; }
    .en-btn { font-size: 0.75em; display: block; font-weight: 300; opacity: 0.9; margin-top: -2px; }
    
    .pc-table-view { display: block; }
    .pc-table-view th { background-color: #f9f9f9; padding: 15px; font-size: 0.8rem; color: #555; text-align: left; }
    .pc-table-view td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .mobile-result-view { display: none; width: 100%; max-width: 600px; margin: 0 auto; }
    .product-summary-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 5px solid var(--ikea-yellow); }
    .schedule-list { display: flex; flex-direction: column; gap: 10px; }
    .schedule-item { background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #ccc; }
    .schedule-item.fixed-date { border-left-color: var(--ikea-blue); }
    
    .pc-only-text { display: block; } .mobile-only-text { display: none; }
    footer { background-color: #eef0f3; text-align: center; padding: 15px 0; color: #888; font-size: 0.75rem; border-top: 1px solid #e0e0e0; width:100%; flex-shrink: 0; }
    #loading { display: none; margin-top: 20px; color: var(--ikea-blue); }
    #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
    #reader { width: 100%; max-width: 500px; background: black; border-radius: 8px; overflow: hidden; }
    .scan-controls { margin-top: 20px; display: flex; gap: 15px; }
    .btn-modal { padding: 10px 20px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; }
    .btn-close { background: white; color: black; }

    .search-card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 100%; max-width: 800px; text-align: left; }
    .search-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .search-title { font-size: 1.2rem; font-weight: 600; color: var(--ikea-blue); display: flex; align-items: center; gap: 4px; }
    .input-wrapper { display: flex; gap: 10px; height: 50px; }
    input[type="text"] { flex-grow: 1; padding: 0 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    .btn-search { background-color: var(--ikea-blue); color: white; border: none; padding: 0 25px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 1rem; white-space: nowrap; }
    .btn-scan-trigger { display: none; background-color: #333; color: white; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; align-items: center; justify-content: center; }
    .helper-text { margin-top: 15px; font-size: 0.85rem; color: #777; line-height: 1.6; }
    .result-section { width: 100%; max-width: 1200px; margin-top: 30px; display: none; }
    .status-msg { padding: 15px; border-radius: 4px; color: white; font-weight: bold; text-align: center; margin-bottom: 20px; }
    .status-success { background-color: #008844; } .status-fail { background-color: #cc0000; }
    .dashboard { display: flex; gap: 20px; margin-bottom: 30px; max-width: 1000px; margin-left: auto; margin-right: auto; }
    .dash-card { flex: 1; background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid var(--ikea-blue); }
    .dash-card h3 { font-size: 2rem; margin: 10px 0 5px; color: var(--text-dark); }
    .dash-card p { font-size: 0.8rem; color: #888; text-transform: uppercase; margin: 0; }

    @media (max-width: 768px) {
      .app-container { flex-direction: column; display: block; }
      .sidebar { width: 100%; height: auto; flex-direction: row; padding-top: 0; }
      .nav-item { flex: 1; text-align: center; padding: 12px; border-right: 1px solid #ddd; }
      .nav-item.active { border-left: none; border-bottom: 4px solid var(--ikea-yellow); }
      .content-area { padding: 20px 10px; }
      header { height: auto; padding: 20px; flex-direction: column; gap: 10px; text-align: center; }
      .header-left { align-items: center; }
      .link-group { margin-left: 0; justify-content: center; }
      .search-card { padding: 20px; }
      .btn-scan-trigger { display: flex; }
      .dashboard { gap: 10px; }
      .dash-card { padding: 15px 5px; }
      .dash-card h3 { font-size: 1.3rem; }
      .pc-table-view { display: none !important; }
      .mobile-result-view { display: block; }
      .col-hide-mobile { display: none; }
      .pivot-table { min-width: auto; table-layout: auto; }
      .pivot-table th, .pivot-table td { padding: 5px; font-size: 0.7rem; }
      .filter-input { width: 100%; font-size: 0.7rem; }
      .pc-only-text { display: none; }
      .mobile-only-text { display: block; }
      .pivot-header-area { flex-direction: column; gap: 10px; align-items: flex-start; }
      .col-hfb, .col-pa { width: auto; min-width: 30px; }
      .col-itemname { min-width: 150px; }
    }
  </style>
</head>
<body>

  <div id="scanner-modal">
    <div style="color:white; margin-bottom:10px; text-align:center;">
      <i class="fas fa-barcode"></i> 바코드에 카메라를 대주세요
      <div class="en-block en-white">Point camera at barcode</div>
    </div>
    <div id="reader"></div>
    <div class="scan-controls">
      <button class="btn-modal btn-close" onclick="stopScanner()">닫기</button>
    </div>
  </div>

  <header>
    <div class="header-left">
      <a href="." class="main-title"><i class="fas fa-truck-fast" style="color:var(--ikea-yellow);"></i> STO373 Goods Arrival Plan Search</a>
      <div class="link-group">
        <a href="https://coworker.ingka.com/kr/ko/v1/" target="_blank" class="header-sub-link">SäljaPro <i class="fas fa-external-link-alt" style="font-size:.8em;"></i></a>
        <a href="https://www.ikea.com/kr/ko/" target="_blank" class="header-sub-link">IKEA Home <i class="fas fa-home" style="font-size:.8em;"></i></a>
        <a href="https://mhs-373.ikea.com/gateway/" target="_blank" class="header-sub-link">MHS <i class="fas fa-warehouse" style="font-size:.8em;"></i></a>
        <a href="https://piafacts.ikea.net/kr/en" target="_blank" class="header-sub-link">PIA Facts <i class="fas fa-info-circle" style="font-size:.8em;"></i></a>
      </div>
    </div>
    <div class="header-right">
      Ver 4.2 Multi-Select<br/>
      Bilingual Support
      <div id="data-update-date" style="font-size:.9em; color:var(--ikea-yellow); margin-top:3px; font-weight:500;">data update : -</div>
    </div>
  </header>

  <div class="app-container">
    <nav class="sidebar">
      <div class="nav-item active" onclick="switchTab('search')" id="nav-search">Article Search <span class="nav-sub">제품 검색</span></div>
      <div class="nav-item" onclick="switchTab('arrival')" id="nav-arrival">Goods Arrival <span class="nav-sub">상품 도착 현황</span></div>
    </nav>

    <div class="content-area">
      <div id="tab-search" class="tab-content active">
        <div class="search-card">
          <div class="search-header">
            <div class="search-title"><i class="fas fa-search"></i> 검색 (제품 번호 8자리) <span class="en-sub">Search (Item No 8 digits)</span></div>
            <div class="status-badge" id="statusBadge1"><i class="fas fa-spinner fa-spin"></i> 연결 중...</div>
          </div>
          <div class="input-wrapper">
            <input type="text" id="itemInput" placeholder="예: 80518273 (e.g.)" maxlength="20"/>
            <button class="btn-scan-trigger" onclick="startScanner()"><i class="fas fa-camera"></i></button>
            <button class="btn-search" onclick="performSearch()">검색 <span class="en-btn">Search</span></button>
          </div>
          <div class="helper-text">
            <i class="fas fa-lightbulb" style="color:var(--ikea-yellow);"></i> <strong>Tip:</strong>
            <div class="pc-only-text">8자리 숫자를 입력 후 검색을 눌러주세요.</div>
            <div class="mobile-only-text">모바일에서는 카메라 아이콘을 눌러 바코드를 자동으로 입력할 수 있습니다.</div>
          </div>
          <div id="loading"><i class="fas fa-spinner fa-spin fa-2x"></i><br/>데이터 검색 중...</div>
        </div>

        <div id="resultSection" class="result-section">
          <div id="statusBar" class="status-msg"></div>
          <div class="dashboard">
            <div class="dash-card"><h3 id="totalResults">-</h3><p>Total Results</p></div>
            <div class="dash-card"><h3 id="futureDeliveryQty">0</h3><p>Future Qty</p></div>
            <div class="dash-card"><h3 id="nextDeliveryDate">-</h3><p>Next Delivery</p></div>
          </div>
          <div class="pc-table-view">
            <div class="table-wrap">
              <table>
                <thead><tr><th>HFB</th><th>ITEM NO</th><th>ITEM NAME</th><th>SSD</th><th>EDS</th><th>PLANNED DATE</th><th>QTY</th><th>CONTAINER</th></tr></thead>
                <tbody id="pcResultBody"></tbody>
              </table>
            </div>
          </div>
          <div class="mobile-result-view">
            <div id="mobileProductSummary" class="product-summary-card"></div>
            <div id="mobileScheduleList" class="schedule-list"></div>
          </div>
        </div>
      </div>

      <div id="tab-arrival" class="tab-content">
        <div class="filter-tray-container">
          <div class="tray-header">
            <div class="tray-title"><i class="fas fa-filter"></i> Date Filter (Click to Toggle)</div>
            <button class="btn-clear-filter" onclick="clearDateFilters()">
              <i class="fas fa-sync-alt"></i> Clear All / Show All
            </button>
          </div>
          <div class="chip-container" id="dateFilterChips">
            </div>
        </div>

        <div class="pivot-container">
          <div class="pivot-header-area">
            <h2 style="color:var(--ikea-blue); margin:0;">
              <i class="fas fa-calendar-alt"></i> Goods Arrival Overview
              <span class="en-sub" style="font-size:.6em; display:block; margin-left:0; margin-top:5px;">오늘부터 미래의 도착 예정 물량을 보여줍니다.</span>
            </h2>
            <div class="status-badge" id="statusBadge2"><i class="fas fa-spinner fa-spin"></i> 연결 중...</div>
          </div>

          <div style="overflow-x:auto;">
            <table class="pivot-table" id="pivotTable">
              <thead id="pivotHead"></thead>
              <tbody id="pivotBody"></tbody>
            </table>
            <div id="pivotLoading" style="text-align:center; padding:20px; color:#777; display:none;">
              <i class="fas fa-spinner fa-spin"></i> 데이터를 불러오는 중입니다...
            </div>
            <div id="limitWarning" class="limit-warning" style="display:none;">
              <i class="fas fa-info-circle"></i> 성능 최적화를 위해 상위 3000개 결과만 표시됩니다. 더 찾으려면 필터를 사용하세요.<br/>
              <span class="en-sub">Showing top 3000 results for performance. Please use filters to refine.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <strong>STO373 Goods arrival Tool</strong> — Powered by automated STO373 FI
  </footer>

  <script>
    const EXCEL_FILE_URL = './STO373 Goods arrival plan.xlsx';
    let rawData = [];
    let html5QrcodeScanner = null;
    let allPivotRows = [];
    let globalSortedDates = [];
    let selectedDateFilters = new Set(); // Stores 'Not Fixed' or 'YYYY-MM-DD'

    // Utilities
    const debounce = (fn, t=300) => { let tm; return (...a)=>{clearTimeout(tm); tm=setTimeout(()=>fn(...a), t);} };
    const fmtInt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
    const safeNum = v => Number.isFinite(+v) ? +v : 0;
    const pad2 = n => String(n).padStart(2,'0');
    const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    function getWeekNumber(d){
      const target = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNr = (target.getUTCDay() + 6) % 7; 
      target.setUTCDate(target.getUTCDate() - dayNr + 3); 
      const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
      return 1 + Math.round((target - firstThursday) / (7*24*3600*1000));
    }
    function escapeHtml(str=''){
      return String(str).replace(/[&<>"'`=\/]/g, s => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;' }[s]));
    }
    function getSafeDate(raw) {
      if (typeof raw === 'number' && raw < 100000) {
        const d = new Date(Math.round((raw - 25569) * 86400 * 1000) + 43200000);
        return !isNaN(d) && d.getFullYear() > 1900 ? d : null;
      } else if (typeof raw === 'string' && !raw.startsWith("1900")) {
        const d = new Date(raw);
        return !isNaN(d) ? d : null;
      }
      return null;
    }

    // Initialize
    window.onload = async function(){
      try{
        const uniqueUrl = EXCEL_FILE_URL + '?t=' + new Date().getTime();
        const resp = await fetch(uniqueUrl);
        const lastModified = resp.headers.get('Last-Modified');
        if (lastModified){
          const d = new Date(lastModified);
          document.getElementById('data-update-date').innerText = `data update : ${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        }
        if (!resp.ok) throw new Error('Excel file not found');
        const buf = await resp.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array' });
        let sheetName = wb.SheetNames.find(n => String(n).toLowerCase().includes('orderinformation')) || wb.SheetNames[0];
        rawData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { header: "A", defval: "", range: 1 }); 
        
        updateStatus('connected');
        if(document.getElementById('tab-arrival').classList.contains('active')) renderPivotTable(rawData);
        else setTimeout(() => renderPivotTable(rawData, false), 500); 
      } catch (error) { updateStatus('error'); }
    };

    function updateStatus(status) {
      const b1 = document.getElementById('statusBadge1');
      const b2 = document.getElementById('statusBadge2');
      if (status === 'connected') {
        b1.innerHTML = `<i class="fas fa-check-circle"></i> 데이터 연결됨`; b1.className = 'status-badge connected';
        b2.innerHTML = `<i class="fas fa-check-circle"></i> 데이터 연결됨`; b2.className = 'status-badge connected';
      } else {
        b1.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 연결 실패`; b1.className = 'status-badge error';
        b2.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 연결 실패`; b2.className = 'status-badge error';
      }
    }

    function switchTab(tabName) {
      document.getElementById('tab-search').classList.remove('active');
      document.getElementById('tab-arrival').classList.remove('active');
      document.getElementById('nav-search').classList.remove('active');
      document.getElementById('nav-arrival').classList.remove('active');
      document.getElementById('tab-' + tabName).classList.add('active');
      document.getElementById('nav-' + tabName).classList.add('active');
      if (tabName === 'arrival') {
        if (allPivotRows.length > 0) updateTableDisplay(allPivotRows); 
        else if (rawData.length > 0) renderPivotTable(rawData);
        else { document.getElementById('pivotBody').innerHTML = ""; document.getElementById('pivotLoading').style.display = "block"; }
      }
    }

    // --- Tab 1 Search Logic ---
    document.getElementById('itemInput').addEventListener('keypress', e => { if (e.key==='Enter') performSearch(); });
    function performSearch() {
      const inputRaw = document.getElementById('itemInput').value.trim();
      if (!inputRaw) { alert("제품번호를 입력해주세요."); return; }
      const cleanInput = inputRaw.replace(/[^0-9]/g, '');
      document.getElementById('loading').style.display = 'block';
      document.getElementById('resultSection').style.display = 'none';
      setTimeout(() => {
        const results = searchExcel(cleanInput);
        displayResults(results);
        document.getElementById('loading').style.display = 'none';
      }, 300);
    }
    function parseExcelDate(value) {
      if (!value) return "-";
      if (typeof value === 'number') {
        if (value > 19000000) return `${String(value).substring(0, 4)}-${String(value).substring(4, 6)}-${String(value).substring(6, 8)}`;
        const d = getSafeDate(value);
        return d ? d.toISOString().split('T')[0] : "-";
      }
      return value;
    }
    function searchExcel(target) {
      const groupedMap = new Map();
      const today = new Date(); today.setHours(0,0,0,0);
      rawData.forEach(row => {
        let itemNo = String(row['E'] || "").trim().replace(/[^0-9]/g, '');
        let container = String(row['B'] || "").trim();
        let cleanCont = container.replace(/[^a-zA-Z0-9]/g, '');
        let isMatch = (itemNo && (itemNo.includes(target) || target.includes(itemNo))) || (cleanCont && cleanCont.toLowerCase().includes(target.toLowerCase()));
        if (isMatch) {
          let pDate = getSafeDate(row['M']);
          let portDate = getSafeDate(row['U']);
          let pStr = "미정";
          if (pDate) {
            const checkDate = new Date(pDate); checkDate.setHours(0,0,0,0);
            if (checkDate < today) return;
            pStr = pDate.toISOString().split('T')[0];
          } else if (portDate) {
            const estDate = new Date(portDate); estDate.setDate(estDate.getDate() + 7);
            const weekNo = getWeekNumber(estDate);
            pStr = `<span class="date-estimated">WK${weekNo} 예상</span>`;
          } else {
            pStr = `<span class="date-tbd">미정</span>`;
          }
          if (container === "") container = "배송준비중";
          const key = `${container}_${pStr}`;
          let qty = parseFloat(row['P']) || 0;
          if (groupedMap.has(key)) groupedMap.get(key).quantity += qty;
          else groupedMap.set(key, { hfb: row['F'], itemNo: String(row['E'] || "").trim(), itemName: row['C'], ssdRaw: row['G'], edsRaw: row['H'], plannedDateStr: pStr, plannedDateObj: pDate, quantity: qty, container });
        }
      });
      return Array.from(groupedMap.values());
    }
    function displayResults(results) {
      const resultSection = document.getElementById('resultSection');
      const statusBar = document.getElementById('statusBar');
      const pcTbody = document.getElementById('pcResultBody');
      const mobileScheduleList = document.getElementById('mobileScheduleList');
      const mobileProductSummary = document.getElementById('mobileProductSummary');
      resultSection.style.display = 'block';
      pcTbody.innerHTML = ''; mobileScheduleList.innerHTML = ''; mobileProductSummary.innerHTML = '';
      if (results.length > 0) {
        statusBar.innerHTML = `${results.length}개의 배송 계획을 찾았습니다! <div class="en-white" style="font-size:0.85em; opacity:0.9; font-weight:300;">Found ${results.length} arrival plans!</div>`;
        statusBar.className = 'status-msg status-success';
        document.querySelector('.dashboard').style.display = 'flex';
      } else {
        statusBar.innerHTML = `검색 결과가 존재하지 않습니다.<br><span style="font-size:0.8em">(과거 날짜는 표시되지 않습니다)</span>`;
        statusBar.className = 'status-msg status-fail';
        document.querySelector('.dashboard').style.display = 'none';
        return;
      }
      document.getElementById('totalResults').innerText = results.length;
      results.sort((a, b) => {
        const dateA = a.plannedDateObj || new Date(9999,0,1);
        const dateB = b.plannedDateObj || new Date(9999,0,1);
        return dateA - dateB;
      });
      const future = results.filter(r => r.plannedDateObj !== null);
      if (future.length > 0) {
        const nextDate = future[0].plannedDateStr;
        const totalNext = future.filter(r => r.plannedDateStr === nextDate).reduce((s, i) => s + i.quantity, 0);
        document.getElementById('futureDeliveryQty').innerText = totalNext;
        document.getElementById('nextDeliveryDate').innerText = nextDate;
      } else {
        document.getElementById('futureDeliveryQty').innerText = "0";
        document.getElementById('nextDeliveryDate').innerText = "-";
      }
      results.forEach(row => {
        let dateHtml = row.plannedDateStr;
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateHtml)) dateHtml = `<span class="date-confirmed">${dateHtml}</span>`;
        pcTbody.innerHTML += `<tr><td>${row.hfb}</td><td><strong>${row.itemNo}</strong></td><td>${row.itemName}</td><td>${parseExcelDate(row.ssdRaw)}</td><td>${parseExcelDate(row.edsRaw)}</td><td>${dateHtml}</td><td style="font-weight:bold; color:var(--ikea-blue);">${row.quantity}</td><td>${row.container}</td></tr>`;
      });
      if(results.length > 0) {
        const c = results[0];
        mobileProductSummary.innerHTML = `<div class="summary-row"><span class="label">Item No</span> <span class="value" style="font-size:1.2rem; color:var(--ikea-blue);">${c.itemNo}</span></div><div class="summary-row"><span class="label">Name</span> <span class="value">${c.itemName}</span></div><div class="summary-row"><span class="label">HFB</span> <span class="value">${c.hfb}</span></div>`;
        results.forEach(row => {
          mobileScheduleList.innerHTML += `<div class="schedule-item"><div class="schedule-date">${row.plannedDateStr}</div><div class="schedule-details"><div class="schedule-qty">${row.quantity} ea</div><div class="schedule-container"><i class="fas fa-box"></i> ${row.container}</div></div></div>`;
        });
      }
    }

    // --- Tab 2 Pivot & Filter Logic ---
    function renderPivotTable(data, shouldRender = true) {
      const today = new Date(); today.setHours(0,0,0,0);
      const pivotMap = {};
      const uniqueDates = new Set();
      let hasNotFixed = false;

      data.forEach(row => {
        let pDate = getSafeDate(row['M']);
        const itemNo = String(row['E'] || "").trim();
        const qty = parseFloat(row['P']) || 0;
        if (!itemNo) return;

        if (!pivotMap[itemNo]) {
          pivotMap[itemNo] = { hfb: row['F']||"", pa: row['D']||"", itemNo: itemNo, itemName: row['C']||"", activity: row['L']||"", dates: {}, notFixedQty: 0 };
        }
        if (pDate) {
          const checkDate = new Date(pDate); checkDate.setHours(0,0,0,0);
          if (checkDate >= today) {
            const pStr = pDate.toISOString().split('T')[0];
            if (!pivotMap[itemNo].dates[pStr]) pivotMap[itemNo].dates[pStr] = 0;
            pivotMap[itemNo].dates[pStr] += qty;
            uniqueDates.add(pStr);
          }
        } else {
          pivotMap[itemNo].notFixedQty += qty;
          hasNotFixed = true;
        }
      });

      globalSortedDates = Array.from(uniqueDates).sort();
      
      // Render Filter Chips (Initial)
      renderDateFilterChips(globalSortedDates, hasNotFixed);

      // Header
      let headerHtml = `<tr><th class="col-hfb">HFB<br><input type="text" class="filter-input" placeholder="Filter"></th><th class="col-pa">PA<br><input type="text" class="filter-input" placeholder="Filter"></th><th class="col-itemno">Item No<br><input type="text" class="filter-input" placeholder="Filter"></th><th class="col-itemname col-hide-mobile">Item Name<br><input type="text" class="filter-input" placeholder="Filter"></th><th class="col-activity col-hide-mobile">Activity<br><input type="text" class="filter-input" placeholder="Filter"></th><th class="not-fixed-col">미정<br>(Not Fixed)</th>`;
      globalSortedDates.forEach(d => headerHtml += `<th class="date-col">${d}</th>`);
      headerHtml += `</tr>`;
      document.getElementById('pivotHead').innerHTML = headerHtml;

      allPivotRows = Object.values(pivotMap).sort((a, b) => {
        if (a.hfb !== b.hfb) return String(a.hfb).localeCompare(String(b.hfb));
        return String(a.pa).localeCompare(String(b.pa));
      });

      document.getElementById('pivotLoading').style.display = "none";
      const inputs = document.querySelectorAll("#pivotTable .filter-input");
      inputs.forEach(input => { input.addEventListener('input', debounce(() => filterPivot(), 350)); });

      if(shouldRender) updateTableDisplay(allPivotRows);
    }

    function renderDateFilterChips(dates, hasNotFixed) {
      const container = document.getElementById('dateFilterChips');
      container.innerHTML = ''; 

      // Helper
      const createChip = (val, label) => {
        const div = document.createElement('div');
        div.className = 'filter-chip';
        if(selectedDateFilters.has(val)) div.classList.add('active');
        div.innerHTML = `<i class="fas fa-calendar-check"></i> ${label}`;
        div.onclick = () => {
          if(selectedDateFilters.has(val)) {
            selectedDateFilters.delete(val);
            div.classList.remove('active');
          } else {
            selectedDateFilters.add(val);
            div.classList.add('active');
          }
          filterPivot();
        };
        return div;
      };

      if(hasNotFixed) container.appendChild(createChip('Not Fixed', 'Not Fixed (미정)'));
      dates.forEach(d => container.appendChild(createChip(d, d)));
    }

    function clearDateFilters() {
      selectedDateFilters.clear();
      // Re-render chips to remove active class
      const chips = document.querySelectorAll('.filter-chip');
      chips.forEach(c => c.classList.remove('active'));
      filterPivot();
    }

    function updateTableDisplay(rowsToRender) {
      const tbody = document.getElementById('pivotBody');
      const limitWarning = document.getElementById('limitWarning');
      const limit = 3000;
      let bodyHtml = "";
      const count = Math.min(rowsToRender.length, limit);

      for (let i = 0; i < count; i++) {
        const row = rowsToRender[i];
        const notFixedDisplay = row.notFixedQty > 0 ? row.notFixedQty : "";
        
        bodyHtml += `<tr><td class="col-hfb">${row.hfb}</td><td class="col-pa">${row.pa}</td><td class="col-itemno"><b>${row.itemNo}</b></td><td class="col-itemname col-hide-mobile" style="text-align:left;">${row.itemName}</td><td class="col-activity col-hide-mobile">${row.activity}</td><td class="not-fixed-col">${notFixedDisplay}</td>`;
        globalSortedDates.forEach(date => {
          const q = row.dates[date] || "";
          bodyHtml += `<td class="qty-cell">${q}</td>`;
        });
        bodyHtml += `</tr>`;
      }
      tbody.innerHTML = bodyHtml;
      limitWarning.style.display = rowsToRender.length > limit ? 'block' : 'none';
    }

    function filterPivot() {
      const inputs = document.querySelectorAll("#pivotTable .filter-input");
      const filters = Array.from(inputs).map(i => i.value.toUpperCase());

      const filteredRows = allPivotRows.filter(row => {
        // Text Filters (AND condition)
        if (filters[0] && String(row.hfb).toUpperCase().indexOf(filters[0]) === -1) return false;
        if (filters[1] && String(row.pa).toUpperCase().indexOf(filters[1]) === -1) return false;
        if (filters[2] && String(row.itemNo).toUpperCase().indexOf(filters[2]) === -1) return false;
        if (filters[3] && String(row.itemName).toUpperCase().indexOf(filters[3]) === -1) return false;
        if (filters[4] && String(row.activity).toUpperCase().indexOf(filters[4]) === -1) return false;

        // Date Filter Logic (OR condition)
        if (selectedDateFilters.size > 0) {
          let hasDataInSelectedDate = false;
          // Check Not Fixed
          if (selectedDateFilters.has('Not Fixed') && row.notFixedQty > 0) hasDataInSelectedDate = true;
          // Check Dates
          if (!hasDataInSelectedDate) {
            for (let date of globalSortedDates) {
              if (selectedDateFilters.has(date) && row.dates[date] > 0) {
                hasDataInSelectedDate = true;
                break;
              }
            }
          }
          if (!hasDataInSelectedDate) return false;
        }
        return true;
      });
      updateTableDisplay(filteredRows);
    }

    function startScanner() { document.getElementById('scanner-modal').style.display = 'flex'; if(!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("reader"); html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 300, height: 150 }, aspectRatio: 1.0 }, onScanSuccess).catch(e=>alert("Camera Error")); }
    function onScanSuccess(t) { document.getElementById('itemInput').value = t.replace(/[^0-9]/g, ''); stopScanner(); performSearch(); }
    function stopScanner() { if(html5QrcodeScanner) html5QrcodeScanner.stop().then(()=>document.getElementById('scanner-modal').style.display='none'); else document.getElementById('scanner-modal').style.display='none'; }
  </script>
</body>
</html>
